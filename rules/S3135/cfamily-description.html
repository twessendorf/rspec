<div class="paragraph">
<p><code>sizeof</code> returns the size in bytes of a type. <code>alignof</code> (since C&#43;&#43;-11) returns the alignment, in bytes, required for any instance of a type. Using any other kind of value with <code>sizeof</code>, or <code>alignof</code>, is likely a mistake - what is returned is the size, or alignment, of the operand&#8217;s type.</p>
</div>
<div class="paragraph">
<p>This rule raises issues for the following <code>sizeof</code>, and <code>alignof</code> calls:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>with parameters that have a <code>void</code> type. That is forbidden by both the C and C&#43;&#43; standards</p>
</li>
<li>
<p>on a pointer type variable. This is typically a mistake; usually the intent is to get the size, or alignment, of the pointed-to value instead</p>
</li>
<li>
<p>when the parameter is another <code>sizeof</code>, or <code>alignof</code> call. <code>sizeof(sizeof(...))</code> indicates a misuse or misunderstanding of the <code>sizeof</code> construct</p>
</li>
<li>
<p>when side effects are intended in the parameter. The side effects don&#8217;t actually occur; the expression is not evaluated because <code>sizeof</code> only acts on the type of the expression</p>
</li>
<li>
<p>when there are calculations within <code>sizeof</code>, or <code>alignof</code>; the result will be <code>sizeof(int)</code>, or <code>alignof(int)</code>, assuming the calculation&#8217;s operands are <code>int</code>s</p>
</li>
<li>
<p>when numeric constants are used with <code>sizeof</code> or <code>alignof</code>. Such calls simply return <code>sizeof(int)</code> or <code>alignof(int)</code> respectively.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>void fun(int array[10]) {
  int length = 42;

  for (size_t i = 0; i &lt; sizeof(array) / sizeof(*array); i++) { // Noncompliant, type of array decays to int *, so sizeof(array) evaluates to sizeof(int *)
    array[i] = 0;
  }

  size_t size = sizeof(i = 1234); // Noncompliant, side effect
  size = sizeof(i++); // Noncompliant, side effect

  size = sizeof(sizeof(i)); // Noncompliant, one sizeof call was intended

  char *cp = malloc(sizeof(length + 1));  // Noncompliant, calculation in parameter

  size = sizeof(10); // Noncompliant, constant as parameter

  void* p;
  alignof(*p);  // Noncompliant, void type
  alignof(void);  // Noncompliant, void type
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>void fun(int array[10]) {
  int length = 42;

  for (size_t i = 0; i &lt; count; i++) {
    array[i] = 0;
  }

  int i = 1234;
  size_t size = sizeof( i );
  i++;
  size = sizeof (i);

  size = sizeof(i);

  char *cp = malloc((length + 1) * sizeof(char));

  size = sizeof(int);
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>MISRA C:2004, 12.3 - The sizeof operator shall not be used on expressions that contain side effects.</p>
</li>
<li>
<p>MISRA C&#43;&#43;:2008, 5-3-4 - Evaluation of the operand to the sizeof operator shall not contain side effects.</p>
</li>
<li>
<p>MISRA C:2012, 13.6 - The operand of the sizeof operator shall not contain any expression which has potential side effects</p>
</li>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/CdYxBQ">CERT, ARR01-C.</a> - Do not apply the <code>sizeof</code> operator to a pointer when taking the size of an array</p>
</li>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/_NYxBQ">CERT, EXP44-C.</a> - Do not rely on side effects in operands to <code>sizeof</code>, <code>_Alignof</code>, or <code>_Generic</code></p>
</li>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/oXs-BQ">CERT, EXP52-CPP.</a> - Do not rely on side effects in unevaluated operands</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/467.html">MITRE, CWE-467</a> - Use of sizeof() on a Pointer Type</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Remove this calculation inside the "sizeof".</p>
</li>
<li>
<p>Remove this use of "sizeof" with a numeric constant.</p>
</li>
<li>
<p>Remove the inner "sizeof".</p>
</li>
<li>
<p>Refactor this use of "sizeof" on expression of a pointer type.</p>
</li>
<li>
<p>Remove any possible side effects from this "sizeof".</p>
</li>
<li>
<p>Don&#8217;t use "sizeof" with an operand of a "void" type.</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_deprecates_s2215">deprecates: S2215</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s1913">deprecates: S1913</h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s922">is related to: S922</h3>

</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_102519_massimo_paladin_wrote">on 29 Jun 2015, 10:25:19 Massimo PALADIN wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] could you please verify this spec?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_115101_ann_campbell_wrote">on 29 Jun 2015, 11:51:01 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin], I&#8217;ve made a few edits which you&#8217;ll want to double-check, but I don&#8217;t like the code example. I would have expected to see a <code>malloc</code> rather than an array declaration. Something like the following which is (when correctly written) a common idiom:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int size = 42;
char *cp = malloc(sizeof(char * size));  // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p>and</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int size = 42;
char *cp = malloc(size * sizeof(char));</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_jun_2015_132224_ann_campbell_wrote">on 29 Jun 2015, 13:22:24 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>check it over, please [~massimo.paladin]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_jun_2015_151224_ann_campbell_wrote">on 30 Jun 2015, 15:12:24 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~massimo.paladin] I&#8217;ve edited the description some. Please double-check me.</p>
</div>
<div class="paragraph">
<p>Also I favor moving <code>sizeof</code> out of RSPEC-2665 and consolidating all the bad arguments to <code>sizeof</code> here. That would leave RSPEC-2665 as: "alignof" should not be used with operands of a "void" type</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_jul_2015_202602_ann_campbell_wrote">on 2 Jul 2015, 20:26:02 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>FYI [~massimo.paladin] I suggest a title of: Valid arguments should be passed to "sizeof"</p>
</div>
<div class="paragraph">
<p>It&#8217;s slightly more specific</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_3_jul_2015_065154_massimo_paladin_wrote">on 3 Jul 2015, 06:51:54 Massimo PALADIN wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] title updated.</p>
</div>
</div>
</div>
</div>