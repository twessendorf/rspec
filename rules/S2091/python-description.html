<div class="paragraph">
<p>User provided data, such as URL parameters, should always be considered untrusted and tainted. Constructing XPath expressions directly from tainted data enables attackers to inject specially crafted values that changes the initial meaning of the expression itself. Successful XPath injection attacks can read sensitive information from XML documents.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Standard xml module (<a href="https://docs.python.org/3/library/xml.etree.elementtree.html">xml.etree.ElementTree</a>) is not recommended:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>it <a href="https://docs.python.org/3/library/xml.etree.elementtree.html#xpath-support">provides a limited support of xpath</a> expressions</p>
</li>
<li>
<p>to parse <a href="https://docs.python.org/3.9/library/xml.html#xml-vulnerabilities">untrusted xml for other security reasons</a></p>
</li>
<li>
<p>does not have a way to <a href="https://wiki.sei.cmu.edu/confluence/display/java/IDS53-J.+Prevent+XPath+Injection">parameterized xpath expressions</a></p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>from flask import request
import xml.etree.ElementTree as ET

tree = ET.parse('users.xml')
root = tree.getroot()

@app.route('/user')
def user_location():
    username = request.args['username']
    query = "./users/user/[@name='"+username+"']/location"
    elmts = root.findall(query) # Noncompliant
    return 'Location %s' % list(elmts)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://lxml.de/xpathxslt.html">lxml</a> module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from flask import request
from lxml import etree

parser = etree.XMLParser(resolve_entities=False)
tree = etree.parse('users.xml', parser)
root = tree.getroot()

@app.route('/user')
def user_location():
    username = request.args['username']
    query = "/collection/users/user[@name = $paramname]/location/text()"
    elmts = root.xpath(query, paramname = username)
    return 'Location %s' % list(elmts)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/643.html">MITRE, CWE-643</a> - Improper Neutralization of Data within XPath Expressions</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct this XPath expression from user-controlled data.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s4817">relates to: S4817</h3>

</div>
<div class="sect2">
<h3 id="_on_8_oct_2014_072739_nicolas_peru_wrote">on 8 Oct 2014, 07:27:39 Nicolas Peru wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2]Ok with this rule, but I think that during implementation on Java, the checked API should be precised in the description.</p>
</div>
</div>
</div>
</div>