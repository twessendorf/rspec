<div class="paragraph">
<p>The <code>foreach</code> statement was introduced in the C# language prior to generics to make it easier to work with the non-generic collections available at that time such as <code>ArrayList</code>. The <code>foreach</code> statements allows you to downcast elements of a collection of <code>Object</code>s to any other type. The problem is that to achieve the cast, the <code>foreach</code> statements silently performs <code>explicit</code> type conversion, which at runtime can result in an <code>InvalidCastException</code>.</p>
</div>
<div class="paragraph">
<p>C# code iterating on generic collections or arrays should not rely on <code>foreach</code> statement&#8217;s silent <code>explicit</code> conversions.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>public class Fruit { }
public class Orange : Fruit { }
public class Apple : Fruit { }

class MyTest
{
  public void Test()
  {
    var fruitBasket = new List&lt;Fruit&gt;();
    fruitBasket.Add(new Orange());
    fruitBasket.Add(new Orange());
    // fruitBasket.Add(new Apple());  // uncommenting this line will make both foreach below throw an InvalidCastException

    foreach (Fruit fruit in fruitBasket)
    {
      var orange = (Orange)fruit; // This "explicit" conversion is hidden within the foreach loop below
      ...
    }

    foreach (Orange orange in fruitBasket) // Noncompliant
    {
      ...
    }
  }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>var fruitBasket = new List&lt;Orange&gt;();
fruitBasket.Add(new Orange());
fruitBasket.Add(new Orange());
// fruitBasket.Add(new Apple());  // uncommenting this line won't compile

foreach (Orange orange in fruitBasket)
{
  ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>var fruitBasket = new List&lt;Fruit&gt;();
fruitBasket.Add(new Orange());
fruitBasket.Add(new Orange());
fruitBasket.Add(new Apple());

foreach (Orange orange in fruitBasket.OfType&lt;Orange&gt;())
{
  ...
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The rule ignores iterations on collections of <code>object</code>s. This includes legacy code that uses <code>ArrayList</code>. Furthermore, the rule does not report on cases when user defined conversions are being called.</p>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Either change the type of "xxx" to "yyy" or iterate on a generic collection of type "zzz".</p>
</div>
<div class="paragraph">
<p>(e.g. make "element" a "Base".)</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_1_jul_2015_162311_ann_campbell_wrote">on 1 Jul 2015, 16:23:11 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] as I was writing this it occurred to me that someone might write this code thinking they were filtering the array (or whatever was being <code>foreach</code>ed) so that the inner code would only be called for instances of the derived type.</p>
</div>
<div class="paragraph">
<p>Am I correct in thinking that we can/should recommend LINQ usage to accomplish that?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_jul_2015_065237_tamas_vajk_wrote">on 2 Jul 2015, 06:52:37 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Yes, you are right. If the dev wants to filter the list by type, the <code>arr.OfType&lt;Raspberry&gt;()</code> should be used in the <code>foreach</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_jul_2015_124333_ann_campbell_wrote">on 2 Jul 2015, 12:43:33 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Please double-check me [~tamas.vajk]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_2_jul_2015_134442_tamas_vajk_wrote">on 2 Jul 2015, 13:44:42 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] looks good.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_jul_2015_115955_dinesh_bolkensteyn_wrote">on 29 Jul 2015, 11:59:55 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>Eric Lippert says he implemented this rule on the C# compiler, but then removed it because of the huge amount of false positives in Microsoft&#8217;s own C# code, so this should be "MAJOR" and "suspicious" at most.</p>
</div>
<div class="paragraph">
<p><a href="http://ericlippert.com/2013/07/22/why-does-a-foreach-loop-silently-insert-an-explicit-conversion/" class="bare">http://ericlippert.com/2013/07/22/why-does-a-foreach-loop-silently-insert-an-explicit-conversion/</a></p>
</div>
</div>
</div>
</div>