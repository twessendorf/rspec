<div class="paragraph">
<p>Prefer <code>make_unique</code> and <code>make_shared</code> over explicitly calling the constructor of <code>unique_ptr</code> and <code>shared_ptr</code>, they are more concise since they don&#8217;t require specifying the type multiple times and they eliminate the need to use new!</p>
</div>
<div class="paragraph">
<p><strong>Exception-Safety</strong></p>
</div>
<div class="paragraph">
<p>While <code>make_unique</code> and <code>make_shared</code> are exception-safe, complex construction of <code>unique_ptr</code> and <code>shared_ptr</code> might not be.</p>
</div>
<div class="paragraph">
<p>This is because C&#43;&#43; allows arbitrary order of evaluation of subexpressions.</p>
</div>
<div class="paragraph">
<p>Consider this example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>f(unique_ptr&lt;Lhs&gt;(new Lhs()), throwingFunction());</pre>
</div>
</div>
<div class="paragraph">
<p>This scenario can happen:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Memory is allocated for <code>Lhs</code></p>
</li>
<li>
<p><code>Lhs</code> object is constructed</p>
</li>
<li>
<p><code>throwingFunction</code> is called before the <code>unique_ptr</code> construction</p>
</li>
<li>
<p><code>throwingFunction</code> throws an exception.</p>
</li>
<li>
<p>The constructed <code>Lhs</code> object is leaked since the <code>unique_ptr</code> isn&#8217;t constructed yet</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Note: This scenario can only happen before <code>C&#43;&#43;17</code>. the new standard states that each argument needs to be fully evaluated before the evaluation of the other arguments. In this case, the explicit construction of <code>unique_ptr</code> and <code>shared_ptr</code> is exception-safe.</p>
</div>
<div class="paragraph">
<p><strong>Performance</strong></p>
</div>
<div class="paragraph">
<p>While <code>make_uniqe()</code> doesn&#8217;t have an impact on performance, <code>make_shared()</code> does.</p>
</div>
<div class="paragraph">
<p><code>make_shared()</code> performs one heap-allocation. While constructing <code>shared_ptr()</code> explicitly will require two: one for the object being managed and the other for the control block that stores data about the ref-counts and the <code>shared_ptr()</code> deleter.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>std::unique_ptr&lt;MyClass&gt; uniqueP(new MyClass(42)); // Noncompliant
std::shared_ptr&lt;MyClass&gt; sharedP(new MyClass(42)); // Noncompliant</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>auto uniqueP = std::make_unique&lt;MyClass&gt;(42);
auto sharedP = std::make_shared&lt;MyClass&gt;(42);
std::unique_ptr&lt;std::FILE, std::function&lt;void(std::FILE*)&gt;&gt; file(
  fopen("example.txt", "r"),
  [](FILE* inFile) { fclose(inFile); }); // compliant: custom deleter is specified</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule ignores code that uses features not supported by <code>make_shared</code> or <code>make_unique</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>make_shared</code> and <code>make_unique</code>: using custom deleters,</p>
</li>
<li>
<p><code>make_shared</code> and <code>make_unique</code>: calling placement-new, i.e. version of <code>new</code> with arguments, like <code>new(std::nothrow)</code></p>
</li>
<li>
<p><code>make_shared</code> only: using operator <code>new</code> provided by class</p>
</li>
<li>
<p><code>make_shared</code> before C&#43;&#43;20: allocating arrays</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/isocpp/CppCoreGuidelines/blob/c553535fb8dda2839d13ab5f807ffbc66b63d67b/CppCoreGuidelines.md#c150-use-make_unique-to-construct-objects-owned-by-unique_ptrs">C&#43;&#43; Core Guidelines C.150</a> - Use make_unique() to construct objects owned by unique_ptrs</p>
</li>
<li>
<p><a href="https://github.com/isocpp/CppCoreGuidelines/blob/c553535fb8dda2839d13ab5f807ffbc66b63d67b/CppCoreGuidelines.md#c151-use-make_shared-to-construct-objects-owned-by-shared_ptrs">C&#43;&#43; Core Guidelines C.151</a> - Use make_shared() to construct objects owned by shared_ptrs</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use "(make_unique/make_shared)" instead.</p>
</div>
</div>
</div>
</div>