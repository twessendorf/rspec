<div class="paragraph">
<p>In C&#43;&#43;, you should not directly manipulate resources (a database transaction, a network connection, a mutex lock), but encapsulate them in RAII wrapper classes that will allow to manipulate them safely. When defining one of those wrapper classes, you cannot rely on the compiler-generated special member functions to manage the class' resources for you (see the Rule-of-Zero, S4963). You must define those functions yourself to make sure the class' resources are properly copied, moved, and destroyed.</p>
</div>
<div class="paragraph">
<p>In that case, make sure you consider what should be done for all five special functions (all three of them if your compiler is pre-C&#43;&#43;11):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The destructor, to release the resource when the wrapper is destroyed</p>
</li>
<li>
<p>The copy constructor and the copy-assignment operator, to handle what should happen to the resource when the wrapper is copied (a valid option is to disable those operations with <code>=delete</code>)</p>
</li>
<li>
<p>The move constructor and the move-assignment operator, to handle what should happen to the resource when the wrapper is moved (since C&#43;&#43;11). If you cannot find a way to implement them more efficiently than the copy operations, as an exception to this rule, you can just leave out these operations: the compiler will not generate them and will use the copy operations as a fallback.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Those operations work together, and letting the compiler automatically generate some of them, but not all, means that when one of those functions is called, the integrity of the resource will probably be compromised (for instance, it might lead to double release of a resource when the wrapper is copied).</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>class FooPointer { // Noncompliant, missing copy constructor and copy-assignment operator
  Foo* pFoo;
public:
  FooPointer(int initValue) {
    pFoo = new Foo(initValue);
  }
  ~FooPointer() {
    delete pFoo;
  }
};

int main() {
  FooPointer a(5);
  FooPointer b = a; // implicit copy constructor gives rise to double free memory error
  return 0;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>class FooPointer { // Compliant, although it's usually better to reuse an existing wrapper for memory
  Foo* pFoo;
public:
  FooPointer(int initValue) {
    pFoo = new Foo(initValue);
  }
  FooPointer(FooPointer&amp; other) {
    pFoo = new Foo(other.pFoo-&gt;value);
  }
  FooPointer&amp; operator=(const FooPointer&amp; other) {
    int val = other.pFoo-&gt;value;
    delete pFoo;
    pFoo = new Foo(val);
    return *this;
  }
  FooPointer(FooPointer &amp;&amp;fp) noexcept {
    pFoo = fp.pFoo;
    fp.pFoo = nullptr;
  }
  FooPointer const &amp; operator=(FooPointer &amp;&amp;fp) {
    FooPointer temp(std::move(fp));
    std::swap(temp.pFoo, pFoo);
    return *this;
  }
  ~FooPointer() {
    delete pFoo;
  }
};

int main() {
  FooPointer a(5);
  FooPointer b = a; // no error
  return 0;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://wiki.sei.cmu.edu/confluence/x/oHs-BQ">CERT, OOP54-CPP.</a> - Gracefully handle self-copy assignment</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Explicitly define the missing "[copy constructor|copy-assignment operator|destructor|move constructor|move-assignment operator]" so that it will not be implicitly provided.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>class name</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s1234">is duplicated by: S1234</h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s4963">relates to: S4963</h3>

</div>
<div class="sect2">
<h3 id="_on_1_jun_2016_172931_ann_campbell_wrote">on 1 Jun 2016, 17:29:31 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~alban.auzeill], you mentioned in our discussion something about not raising false positives when the move constructor and move-assignment operator are missing. I didn&#8217;t really get the details of that, so it&#8217;s not included here and we&#8217;ll probably need to add it. Feel free to stub the details in or add them in a comment.</p>
</div>
<div class="paragraph">
<p>Also, I&#8217;ve changed the code samples from IntPointers to FooPointers &amp; added a second compliant solution, which you&#8217;ll probably want to take a look at.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_jun_2016_174006_ann_campbell_wrote">on 8 Jun 2016, 17:40:06 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>I&#8217;ve made some edits [~alban.auzeill]. Take a look, please.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_aug_2016_180528_ann_campbell_wrote">on 15 Aug 2016, 18:05:28 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~alban.auzeill] this description is extremely long, and I&#8217;d like to shorten it by removing some or all of the C&#43;&#43; 98 and C&#43;&#43; 11 history. Given that you&#8217;ll have final approval, do you mind if I go ahead?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_6_nov_2018_175754_ann_campbell_wrote">on 6 Nov 2018, 17:57:54 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~loic.joly] I find this contradictory</p>
</div>
<div class="paragraph">
<p><em>__</em> &#8230;&#8203; If you cannot find a way to implement them more efficiently than the copy operations, you can just leave them out.</p>
</div>
<div class="paragraph">
<p>Those operations work together, and letting the compiler automatically generate some of them, but not all, means that when one of those functions is called, the integrity of the resource will probably be compromised____</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_6_nov_2018_181353_loïc_joly_wrote">on 6 Nov 2018, 18:13:53 Loïc Joly wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] It&#8217;s not really contradictory, because as soon as a copy constructor is written by the user, it disables the automatic generation of the move constructor, so we&#8217;re not letting the compiler do anything. But I see your point, it&#8217;s confusing&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>With that additional information, do you have a counter proposal that is not adding too much text to this already long description?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_22_nov_2018_151457_amélie_renard_wrote">on 22 Nov 2018, 15:14:57 Amélie Renard wrote:</h3>
<div class="paragraph">
<p>Cases which could need an explanation :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Destructor is defined in order to check that the object can really be destroyed (use of assert())
ex : https://peach.sonarsource.com/project/issues?id=c-family%3Aclang&amp;issues=AWczye3UUxytsEdVyqlH&amp;open=AWczye3UUxytsEdVyqlH</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>(bad example because the class has a reference attribute - but the idea is there)</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Copy constructor and copy assignment operator are defined to keep a counter (or something like that)</p>
</li>
<li>
<p>An attribute is a unique_ptr. So the user defines the copy constructor and the copy-assignment operator to copy what is inside the unique_ptr. But there is no need of a destructor as the unique_ptr takes care of it.
ex : https://peach.sonarsource.com/project/issues?id=c-family%3Aclang&amp;issues=AWczyhmIUxytsEdVyqnR&amp;open=AWczyhmIUxytsEdVyqnR</p>
</li>
<li>
<p>Class which defines the copy constructor and/or copy-assignment operator when it does not need to. This class should apply the "Rule-of-Zero".</p>
</li>
</ul>
</div>
</div>
</div>
</div>