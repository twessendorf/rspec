<div class="paragraph">
<p>In the interests of readability, code that can be simplified should be simplified. To that end, there are several ways <code>IEnumerable</code> language integrated queries (LINQ) can be simplified</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>OfType</code> instead of using <code>Select</code> with <code>as</code> to type cast elements and then null-checking in a query expression to choose elements based on type.</p>
</li>
<li>
<p>Use <code>OfType</code> instead of using <code>Where</code> and the <code>is</code> operator, followed by a cast in a <code>Select</code></p>
</li>
<li>
<p>Use an expression in <code>Any</code> instead of <code>Where(element =&gt; [expression]).Any()</code>.</p>
</li>
<li>
<p>Use <code>Count</code> instead of <code>Count()</code> when it&#8217;s available.</p>
</li>
<li>
<p>Don&#8217;t call <code>ToArray()</code> or <code>ToList()</code> in the middle of a query chain.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using <code>EntityFramework</code> may require enforcing client evaluations. Such queries should use <code>AsEnumerable()</code> instead of <code>ToArray()</code> or <code>ToList()</code> in the middle of a query chain.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>seq1.Select(element =&gt; element as T).Any(element =&gt; element != null);  // Noncompliant; use OfType
seq2.Select(element =&gt; element as T).Any(element =&gt; element != null &amp;&amp; CheckCondition(element));  // Noncompliant; use OfType
seq3.Where(element =&gt; element is T).Select(element =&gt; element as T); // Noncompliant; use OfType
seq4.Where(element =&gt; element is T).Select(element =&gt; (T)element); // Noncompliant; use OfType
seq5.Where(element =&gt; [expression]).Any();  // Noncompliant; use Any([expression])

var num = seq6.Count(); // Noncompliant
var arr = seq.ToList().ToArray(); //Noncompliant
var count = seq.ToList().Count(x=&gt;[condition]); //Noncompliant</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>seq1.OfType&lt;T&gt;().Any();
seq2.OfType&lt;T&gt;().Any(element =&gt; CheckCondition(element));
seq3.OfType&lt;T&gt;();
seq4.OfType&lt;T&gt;();
seq5.Any(element =&gt; [expression])

var num = seq6.Count;
var arr = seq.ToArray();
var count = seq.Count(x=&gt;[condition]);</pre>
</div>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Use "OfType&lt;T&gt;()" here instead.</p>
</li>
<li>
<p>Drop "Where" and move the condition into the "Any".</p>
</li>
<li>
<p>Drop "ToArray" from the middle of the call chain.</p>
</li>
<li>
<p>Replace "ToArray" with "AsEnumerable" in the middle of the call chain.</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_8_jun_2015_083645_tamas_vajk_wrote">on 8 Jun 2015, 08:36:45 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I&#8217;ve changed the description and the code samples of this RSPEC. Can you go through it? Thanks.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_jun_2015_115809_ann_campbell_wrote">on 8 Jun 2015, 11:58:09 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] I&#8217;ve made some edits to the description in an attempt to tighten it up a little. Please double-check me.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_jun_2015_121003_tamas_vajk_wrote">on 8 Jun 2015, 12:10:03 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Thanks, it looks good.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_jun_2015_140932_ann_campbell_wrote">on 9 Jun 2015, 14:09:32 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>see what you think [~tamas.vajk]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jun_2015_091508_tamas_vajk_wrote">on 19 Jun 2015, 09:15:08 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] The description seems okay now.</p>
</div>
<div class="paragraph">
<p>But i have a problem with the R# keys. This rule covers quite a lot of R# rules, and I can&#8217;t put all the code in the field, probably because I reach the max length. :-(</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_jun_2015_130716_ann_campbell_wrote">on 19 Jun 2015, 13:07:16 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] you are hitting a max length. Fortunately, patterns work here. :-)</p>
</div>
<div class="paragraph">
<p>See the FindBugs field in RSPEC-2275 for an example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_jul_2015_090408_tamas_vajk_wrote">on 8 Jul 2015, 09:04:08 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I&#8217;ve modified the last point as it is not specific to <code>Count</code>.</p>
</div>
<div class="paragraph">
<p>But a now that I&#8217;m thinking about it, we will have exceptions to this rule.</p>
</div>
<div class="paragraph">
<p>In case of <code>seq.ToList().Count(e=&gt; condition)</code> or <code>seq.ToList().Where(e=&gt; condition)</code>, it doesn&#8217;t make sense to call the <code>ToList</code>. But <code>seq.ToList().Count()</code> is faster then <code>seq.Count()</code> because internally it uses a single call to the <code>Count</code> property, which is present on a list. (However, in this case we shouldn&#8217;t use <code>.Count()</code>, but <code>.Count</code>.)</p>
</div>
<div class="paragraph">
<p>So we might want to add an additional covered case:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>using <code>.Count()</code> doesn&#8217;t make sense on <code>IEnumerable</code>s that are known to be of a derived type that has the more performant <code>.Count</code> property.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>WDYT?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_8_jul_2015_142732_ann_campbell_wrote">on 8 Jul 2015, 14:27:32 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>I&#8217;ve added the <code>Count()</code>/<code>Count</code> case.</p>
</div>
<div class="paragraph">
<p>Do we need to add an exception? If so, I need some help on the wording: under what circumstances is <code>ToList().Count</code> faster? Always? If so, we can just add that "except when&#8230;&#8203;" to the relevant case.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_20_jul_2015_120209_tamas_vajk_wrote">on 20 Jul 2015, 12:02:09 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Looks good. We don&#8217;t need the exception now that we have the additional <code>Count</code> case.</p>
</div>
</div>
</div>
</div>