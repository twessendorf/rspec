<div class="paragraph">
<p>"Time Of Check to Time Of Use" (TOCTOU) vulnerabilities occur when an application:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>First, checks permissions or attributes of a file: for instance, is a file a symbolic link?</p>
</li>
<li>
<p>Next, performs some operations such as writing data to this file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The application cannot assume the state of the file is unchanged between these two steps, there is a race condition (ie: two different processes can access and modify the same shared object/file at the same time, which can lead to privilege escalation, denial of service and other unexpected results).</p>
</div>
<div class="paragraph">
<p>For instance, attackers can benefit from this situation by creating a symbolic link to a sensitive file directly after the first step (eg in Unix: <code>/etc/passwd</code>) and try to elevate their privileges (eg: if the written data has the correct <code>/etc/passwd</code> file format).</p>
</div>
<div class="paragraph">
<p>To avoid TOCTOU vulnerabilities, one possible solution is to do a single atomic operation for the "check" and "use" actions, therefore removing the race condition window. Another possibility is to use file descriptors. This way the binding of the file descriptor to the file cannot be changed by a concurrent process.</p>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">OWASP Top 10 2021 Category A1</a> - Broken Access Control</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A5-Broken_Access_Control">OWASP Top 10 2017 Category A5</a> - Boken Access Control</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/367.html">MITRE, CWE-367</a> - Time-of-check Time-of-use (TOCTOU) Race Condition</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Remove this TOCTOU race condition window when accessing files.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_23_sep_2020_203550_ann_campbell_wrote">on 23 Sep 2020, 20:35:50 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~eric.therond], [~hendrik.buchwald] this description would benefit from the addition of what you <em>should</em> do instead&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_105421_hendrik_buchwald_wrote">on 24 Sep 2020, 10:54:21 Hendrik Buchwald wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] in most cases it will probably not be possible to prevent the TOCTOU. [~eric.therond] maybe we could add that the developer should make sure that the file/directory that is affected is not writable by lower privileged users?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_141008_eric_therond_wrote">on 24 Sep 2020, 14:10:08 Eric Therond wrote:</h3>
<div class="paragraph">
<p>To be consistent with compliant solutions proposed in the C-Family sub task I would just add something like that: "<em>To prevent TOCTOUs to occur, remove the race condition window between the check and use operations by performing them atomically or by using file descriptors</em>".</p>
</div>
<div class="paragraph">
<p>\[~hendrik.buchwald] About permissions, I am not completely sure but when developers introduce TOCTOU it is likely to verify permissions of the user with the "check operation":</p>
</div>
<div class="listingblock">
<div class="content">
<pre>if(!access("foo.txt", F_OK)) { // check operation: does the user have the right to access to this file? (operation done with real UID/GID)
   FILE *f = fopen("foo.txt, "w"); // use operation:  (operation done with effective UID/GID)
}</pre>
</div>
</div>
<div class="paragraph">
<p>let say foo.txt is not accessible by the user running the process because foo.txt is owned by root with 700 permissions and the process is owned by root with suid set, so the process will enter in the true block only if the root user is running the process, but in this case the access() call/check operation is useless and can be removed completely. One other solution <a href="https://docs.roguewave.com/en/klocwork/current/sv.toctou.file_access">often</a> mentioned is to do the use operation with the real UID/GID with setuid().</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_142143_hendrik_buchwald_wrote">on 24 Sep 2020, 14:21:43 Hendrik Buchwald wrote:</h3>
<div class="paragraph">
<p>\[~eric.therond] good idea with the file descriptors, I did not think about that. I am not sure how to use the atomic file operations though.</p>
</div>
<div class="paragraph">
<p>With permissions I mean something else. For example, if you have a TOCTOU in the directory <code>/tmp</code> it is likely more dangerous than in the directory <code>/root</code> because in order for an attacker to exploit it they would require root privileges anyway. So what I mean with that is that TOCTOU in regards to security is only relevant if an attacker has the permissions to write where the TOCTOU occurs.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_142958_eric_therond_wrote">on 24 Sep 2020, 14:29:58 Eric Therond wrote:</h3>
<div class="paragraph">
<p>Yeap completely, in fact in <a href="https://jira.sonarsource.com/browse/CPP-2542">the ticket</a> originally it was specified to not raise an issue when the directory is owned by root, likely these ones:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/bin
/boot
/dev
/etc
/lib
/misc
/mnt
/opt
/root
/proc
/sbin
/usr/bin
/usr/etc
/usr/include
/usr/lib
/usr/dict
/usr/kerberos
/usr/libexec
/usr/sbin
/usr/src
/usr/X11R6
/var/cache
/var/db
/var/empty
/var/ftp
/var/lock
/var/log
/var/lib
/var/run</pre>
</div>
</div>
<div class="paragraph">
<p>but it was put aside because even if the TOCTOU is not exploitable, a better code is still possible (like said before with file descriptor or "atomic operations" (x mode with open() for instance).</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_183754_ann_campbell_wrote">on 24 Sep 2020, 18:37:54 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Looks like file descriptors aren&#8217;t a panacea</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://insanecoding.blogspot.com/2007/03/file-descriptors-and-why-we-cant-use.html" class="bare">http://insanecoding.blogspot.com/2007/03/file-descriptors-and-why-we-cant-use.html</a>
____However file descriptors have a general flaw, that being that THE FILE MUST BE OPENABLE. Say for example you have a file with the permissions of 000, you can run stat() or chmod() on it, but you can&#8217;t alter the permissions with fchmod()! Now this might not seem so bad, but say you wanted to make the file writable then write something to it? Or worse, you want one single code base to do some operations in order not to commit the sin of code repetition, but you&#8217;re faced with either using the safer file descriptor based function which doesn&#8217;t always work, or the more dangerous file name based function which will work even if you can&#8217;t open the file.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The problem gets even worse when one considers the new *at() functions Solaris and Linux added. In my case above, say my directory had permissions of 111 (--x&#8212;&#8203;x&#8212;&#8203;x), I can chdir() to it, or access file via the full path. But I can&#8217;t call open() on "/etc/program-a/" as open() for directories only works if the directory has read permissions. If my program allowed one to pass a path to it to tell it where the config files were located, I would need to have two separate code paths, one the fast secure method using openat() and friends, and another calling open() and friends on the full path or chdir() to there and then open() on the file names directly.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.usenix.org/legacy/event/fast08/tech/full_papers/tsafrir/tsafrir_html/index.html#sect:solution" class="bare">https://www.usenix.org/legacy/event/fast08/tech/full_papers/tsafrir/tsafrir_html/index.html#sect:solution</a>
____The second suggestion by Tsyrklevich and Yee was “to use fstat after the open instead of invoking access”. As the input of fstat is a file descriptor, the latter is permanently mapped to the underlying inode and hence can never be abused by an attacker; the user is then expected to inspect the ownership information returned by fstat and check if the invoker was indeed allowed to open the file. But this will not work, as file access permissions can not be deduced in such a way; rather, they are the conjunction of all the (inode) permissions associated with each component in the respective path. For example, if a file&#8217;s name is x/y such that x is solely accessible by its owner, then other users are forbidden from reading y even if fstat indicates it is readable by all (which may very well be the case when root invokes the fstat).</p>
</li>
</ul>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Still, we at least have a suggestion&#8230;&#8203;</p>
</div>
</div>
</div>
</div>