<div class="paragraph">
<p>C&#43;&#43;20 introduced the <code>std::bit_cast</code> function. It standardizes the diverse and sub-optimal approaches of reinterpreting a value as a different type of the same length preserving its binary representation.</p>
</div>
<div class="paragraph">
<p>One of the superseded solutions, know as "union type-punning", is to use a <code>union</code> with two members with types corresponding to the source and the target types of the cast. The operation is performed by saving the value in the member with source type and then reading the value of the target type. Despite being allowed in C, this operation has undefined behavior according to C&#43;&#43; standard and should be replaced by either <code>std::bit_cast</code> (or <code>std::memcpy</code>).</p>
</div>
<div class="paragraph">
<p>This rule raises an issue on any use of a <code>union</code> that should be replaced with <code>std::bit_cast</code>.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>float fastInvSqrt(float number)
  constexpr float threehalfs = 1.5F;
  const float x2 = number * 0.5F;

  union {
     float f;
     uint32_t i;
  } conv;
  conv.f = number
  conv.i = 0x5f3759df - (conv.i &gt;&gt; 1);  // Noncompliant: undefined behavior
  conv.f *= threehalfs - (x2 * conv.f * conv.f); // Noncompliant: undefined behavior
  return conv.f;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>float fastInvSqrt(float number) {
  constexpr float threehalfs = 1.5F;
  const float x2 = number * 0.5F;

  auto i = std::bit_cast&lt;std::uint32_t&gt;(number);
  i  = 0x5f3759df - (i &gt;&gt; 1);
  auto result = std::bit_cast&lt;float&gt;(i);
  result  *= threehalfs - (x2 * result * result);
  return result;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>S6181 - replacing <code>std::memcpy</code> with <code>std::bit_cast</code>.</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s6181">relates to: S6181</h3>

</div>
</div>
</div>