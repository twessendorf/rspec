<div class="paragraph">
<p>While rare, memory leaks can still occur in Java, and <code>static</code> collections are a classic source. This is because <code>static</code> class variables hang around for the life of a program. Unless the contents are diligently managed, items added to the collection shortly after start up will still be there in the collection - and in memory - until shutdown. Thus, you should be very certain that <code>static</code> collections are both required and well-managed.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue on each <code>static</code> collection.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>public class MyClass {
  private static Map &lt;String, Thingy&gt; lookup = new HashMap&lt;&gt;();  // Noncompliant</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule ignores <code>WeakHashMap</code>s, because according to the JavaDocs:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>An entry in a <code>WeakHashMap</code> will automatically be removed when its key is no longer in ordinary use. More precisely, the presence of a mapping for a given key will not prevent the key from being discarded by the garbage collector&#8230;&#8203; When a key has been discarded its entry is effectively removed from the map&#8230;&#8203;</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>However, it is important to note:</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The value objects in a <code>WeakHashMap</code> are held by ordinary strong references. Thus care should be taken to ensure that value objects do not strongly refer to their own keys, either directly or indirectly, since that will prevent the keys from being discarded.</p>
</div>
</blockquote>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="ulist">
<ul>
<li>
<p>Use "WeakHashMap" instead of "HashMap".</p>
</li>
<li>
<p>Remove the "static" keyword from this collection.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"static" keyword</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_12_oct_2015_171812_ann_campbell_wrote">on 12 Oct 2015, 17:18:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] because this rule is related to memory leaks, I have made it a security rule. However, since you could be using a <code>static</code> collection on purpose and managing it well, I have only made it Major/suspicious. I would be interested to hear your thoughts if you disagree.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_oct_2015_171827_ann_campbell_wrote">on 12 Oct 2015, 17:18:27 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] this might apply to you&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_oct_2015_064606_tamas_vajk_wrote">on 15 Oct 2015, 06:46:06 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] This is also applicable to C#. But I have the feeling that it will report many false positives. An examples of valid usages of static lists is storing a list of constants in a list is achieved by having a <code>static readonly</code> array or collection and initializing it inline or in the constructor with the constant values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>private static readonly IImmutableSet&lt;string&gt; AsyncOrAwait = ImmutableHashSet.Create("async", "await");</pre>
</div>
</div>
<div class="paragraph">
<p>And of course as the description says it is possible to use the static collections correctly by maintaining their content properly.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_oct_2015_113712_ann_campbell_wrote">on 15 Oct 2015, 11:37:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] I have similar fears about FP&#8217;s; that&#8217;s why it&#8217;s off by default. Organizations with long-running apps and/or memory concerns can turn it on.</p>
</div>
<div class="paragraph">
<p>It sounds like a C# exception about <code>readonly</code> collections would be appropriate&#8230;&#8203;?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_oct_2015_130444_tamas_vajk_wrote">on 15 Oct 2015, 13:04:44 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Okay, I see. No, we shouldn&#8217;t add the exception for the <code>readonly</code>, because only the instance of the collection can&#8217;t be changed, the content can. But you have no way of specifying a real constant array with a fixed content.</p>
</div>
</div>
</div>
</div>