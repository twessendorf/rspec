<div class="paragraph">
<p>Prototype Pollution vulnerabilities allow to inject new properties into the built-in <code>Object.prototype</code> object. Since most objects inherit from this prototype, it can result in unexpected behavior, e.g., crashes or more severe vulnerabilities.</p>
</div>
<div class="paragraph">
<p>In the past, it has led to the following vulnerabilities:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-10744">CVE-2019-10744</a></p>
</li>
<li>
<p><a href="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2019-11358">CVE-2019-11358</a></p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For merge functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_in_merge(dst, src) {
    for (let key in src) {
        if (dst[key]) {
            for_in_merge(dst[key], src[key]);
        } else {
            dst[key] = src[key];
        }
    }
}

let obj1 = {};
for_in_merge(obj1, req.query.obj2); // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p>For set-path functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_set(target, path, value) {
    let keys = path.split('.');
    for (let i = 0; i &lt; keys.length; ++i) {
        let key = keys[i];
        if (i &lt; keys.length - 1) {
            if (!target[key]) {
                target[key] = {};
            }
            target = target[key];
        } else {
            target[key] = value;
        }
    }
}

for_set(req.query.path, req.query.val); // Noncompliant</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For merge functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_in_merge(dst, src) {
    for (let key in src) {
        // Recommended Secure Coding Practices: prevent sensible keys
        if (key === "constructor" || key === "prototype" || key === "__proto__") {
            continue;
        }

        if (dst[key]) {
            for_in_merge(dst[key], src[key]);
        } else {
            dst[key] = src[key];
        }
    }
}

let obj1 = {};
for_in_merge(obj1, req.query.obj2); // Compliant</pre>
</div>
</div>
<div class="paragraph">
<p>For set-path functions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>function for_set(target, path, value) {
    let keys = path.split('.');
    for (let i = 0; i &lt; keys.length; ++i) {
        let key = keys[i];
        // Recommended Secure Coding Practices: prevent sensible keys
        if (key === "constructor" || key === "prototype" || key === "__proto__") {
            break;
        }
        if (i &lt; keys.length - 1) {
            if (!target[key]) {
                target[key] = {};
            }
            target = target[key];
        } else {
            target[key] = value;
        }
    }
}

for_set(req.query.path, req.query.val); // Compliant</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf">Prototype pollution attack in NodeJS application - Olivier Arteau</a></p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/1321.html">MITRE, CWE-1321</a> - Improperly Controlled Modification of Object Prototype Attributes ('Prototype Pollution')</p>
</li>
</ul>
</div>
</div>
</div>