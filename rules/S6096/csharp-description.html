<div class="paragraph">
<p>File names of the entries in a zip archive should be considered untrusted, tainted and should be validated before being used for file system operations. Indeed, file names can contain specially crafted values, such as '../', that change the initial path and, when accessed, resolve to a path on the filesystem where the user should normally not have access.</p>
</div>
<div class="paragraph">
<p>A successful attack might give an attacker the ability to read, modify, or delete sensitive information from the file system and sometimes even execute arbitrary operating system commands. This special case of path injection vulnerabilities is called "zip slip".</p>
</div>
<div class="paragraph">
<p>The mitigation strategy should be based on the whitelisting of allowed paths or characters.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>using System.Collections.Generic;
using System.IO;
using System.IO.Compression;

namespace ZipSlip
{
    public class ZipSlipNoncompliant
    {
        public void ExtractEntry(IEnumerator&lt;ZipArchiveEntry&gt; entriesEnumerator, string destinationDirectory)
        {
            var entry = entriesEnumerator.Current;
            var destinationPath = Path.Combine(destinationDirectory, entry.FullName);
            entry.ExtractToFile(destinationPath); // Noncompliant
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>using System.Collections.Generic;
using System.IO;
using System.IO.Compression;

namespace ZipSlip
{
    public class ZipSlipCompliant
    {
        public void ExtractEntry(IEnumerator&lt;ZipArchiveEntry&gt; entriesEnumerator, string destinationDirectory)
        {
            var entry = entriesEnumerator.Current;
            var destinationDirectoryFullPath = Path.GetFullPath(destinationDirectory);
            var destinationPath = Path.Combine(destinationDirectoryFullPath, entry.FullName);
            var destinationFullPath = Path.GetFullPath(destinationPath);
            if (!destinationFullPath.StartsWith(destinationDirectoryFullPath))
            {
                throw new IOException("Attempting to extract archive entry outside destination directory");
            }
            entry.ExtractToFile(destinationFullPath); // OK
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">OWASP Top 10 2021 Category A1</a> - Broken Access Control</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://snyk.io/research/zip-slip-vulnerability">snyk</a> - Zip Slip Vulnerability</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/22.html">MITRE, CWE-22</a> - Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/99.html">MITRE, CWE-99</a> - Improper Control of Resource Identifiers ('Resource Injection')</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/641.html">MITRE, CWE-641</a> - Improper Restriction of Names for Files and Other Resources</p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat2">SANS Top 25</a> - Risky Resource Management</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct the path from file name entry of an archive.</p>
</div>
</div>
</div>
</div>