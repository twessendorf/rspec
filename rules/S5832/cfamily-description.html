<div class="paragraph">
<p>Pluggable authentication module (PAM) is a mechanism used on many unix variants to provide a unified way to authenticate users, independently of the underlying authentication scheme.</p>
</div>
<div class="paragraph">
<p>When authenticating users, it is strongly recommended to check the validity of the account (not locked, not expired &#8230;&#8203;), otherwise it leads to unauthorized access to resources.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The account validity is not checked with <code>pam_acct_mgmt</code> when authenticating a user with <code>pam_authenticate</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) { // Noncompliant - missing pam_acct_mgmt
        return -1;
    }

    return 0;
}</pre>
</div>
</div>
<div class="paragraph">
<p>The return value of <code>pam_acct_mgmt</code> is not checked:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) {
        return -1;
    }
    pam_acct_mgmt(pamh, 0); // Noncompliant
    return 0;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When authenticating a user with <code>pam_authenticate</code>, check the account validity with <code>pam_acct_mgmt</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>int valid(pam_handle_t *pamh) {
    if (pam_authenticate(pamh, PAM_DISALLOW_NULL_AUTHTOK) != PAM_SUCCESS) {
        return -1;
    }
    if (pam_acct_mgmt(pamh, 0) != PAM_SUCCESS) { // Compliant
        return -1;
    }
    return 0;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">OWASP Top 10 2021 Category A7</a> - Identification and Authentication Failures</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-top-ten/OWASP_Top_Ten_2017/Top_10-2017_A5-Broken_Access_Control">OWASP Top 10 2017 Category A5</a> - Broken Access Control</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/304.html">MITRE, CWE-304</a> - Missing Critical Step in Authentication</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Check the validity of the account when authenticating users.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_23_sep_2020_204948_ann_campbell_wrote">on 23 Sep 2020, 20:49:48 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Shouldn&#8217;t this reference OWASP A5?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_sep_2020_090252_hendrik_buchwald_wrote">on 24 Sep 2020, 09:02:52 Hendrik Buchwald wrote:</h3>
<div class="paragraph">
<p>Good point, [~ann.campbell.2], thanks! I have added it.</p>
</div>
</div>
</div>
</div>