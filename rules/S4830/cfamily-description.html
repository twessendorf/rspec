<div class="paragraph">
<p>Validation of X.509 certificates is essential to create secure SSL/TLS sessions not vulnerable to man-in-the-middle attacks.</p>
</div>
<div class="paragraph">
<p>The certificate chain validation includes these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The certificate is issued by its parent Certificate Authority or the root CA trusted by the system.</p>
</li>
<li>
<p>Each CA is allowed to issue certificates.</p>
</li>
<li>
<p>Each certificate in the chain is not expired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not recommended to reinvent the wheel by implementing custom certificate chain validation.</p>
</div>
<div class="paragraph">
<p>TLS libraries provide built-in certificate validation functions that should be used.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/curl/curl">libcurl</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;curl/curl.h&gt;

CURL *curl;
curl_global_init(CURL_GLOBAL_DEFAULT);

curl = curl_easy_init();
curl_easy_setopt(curl, CURLOPT_URL, "https://example.com/");
curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 0L); // Noncompliant; CURLOPT_SSL_VERIFYPEER is set to 0, no peer's SSL certificate will be verified

//Perform the request
curl_easy_perform(curl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/openssl/openssl">OpenSSL</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;openssl/ssl.h&gt;

const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);

SSL_CTX_set_verify(ctx, SSL_VERIFY_NONE, NULL); // Noncompliant; SSL_VERIFY_NONE means no automatic certificate verification

SSL *ssl = SSL_new(ctx);

// ...

SSL_connect(ssl);</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;openssl/ssl.h&gt;

static int verify_callback(int preverify_ok, X509_STORE_CTX *ctx) { return 1; } // This callback always validate the certificate

const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);

SSL_CTX_set_verify(ctx, CURLOPT_SSL_VERIFYPEER, verify_callback); // Noncompliant; the verify callback result overrides OpenSSL built-in verification enabled by CURLOPT_SSL_VERIFYPEER option.

SSL *ssl = SSL_new(ctx);

// ...

SSL_connect(ssl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/randombit/botan">botan</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;botan/tls_client.h&gt;
#include &lt;botan/tls_callbacks.h&gt;
#include &lt;botan/tls_session_manager.h&gt;
#include &lt;botan/tls_policy.h&gt;
#include &lt;botan/auto_rng.h&gt;
#include &lt;botan/certstor.h&gt;
#include &lt;botan/certstor_system.h&gt;

class Callbacks : public Botan::TLS::Callbacks
{
// ...

virtual void tls_verify_cert_chain(
          const std::vector&lt;Botan::X509_Certificate&gt; &amp;cert_chain,
          const std::vector&lt;std::shared_ptr&lt;const Botan::OCSP::Response&gt;&gt; &amp;ocsp_responses,
          const std::vector&lt;Botan::Certificate_Store *&gt; &amp;trusted_roots,
          Botan::Usage_Type usage,
          const std::string &amp;hostname,
          const Botan::TLS::Policy &amp;policy) override {} // Noncompliant (secondary location), tls_verify_cert_chain never throws. Always accept server certificate and doesn't verify hostname

};

class Client_Credentials : public Botan::Credentials_Manager
{
// ...
};


Callbacks callbacks;
Botan::AutoSeeded_RNG rng;
Botan::TLS::Session_Manager_In_Memory session_mgr(rng);
Client_Credentials creds;
Botan::TLS::Strict_Policy policy;

// open the tls connection
Botan::TLS::Client client(callbacks, session_mgr, creds, policy, rng,
                          Botan::TLS::Server_Information("example.com", 443),
                          Botan::TLS::Protocol_Version::TLS_V12); // Noncompliant; uses an implementation of Botan::TLS::Callbacks that doesn't validate server certificate</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/curl/curl">libcurl</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;curl/curl.h&gt;

CURL *curl;
curl_global_init(CURL_GLOBAL_DEFAULT);

curl = curl_easy_init();
curl_easy_setopt(curl, CURLOPT_URL, "https://example.com/");
curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 1L); // Compliant; CURLOPT_SSL_VERIFYPEER is set to 1

//Perform the request
curl_easy_perform(curl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/openssl/openssl">OpenSSL</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;openssl/ssl.h&gt;

const SSL_METHOD *method = TLS_method();
SSL_CTX *ctx = SSL_CTX_new(method);

SSL_CTX_set_verify(ctx, SSL_VERIFY_PEER, NULL); // Compliant; CURLOPT_SSL_VERIFYPEER enable OpenSSL's built-in verification of the peer certificate.

SSL *ssl = SSL_new(ctx);

// ...

SSL_connect(ssl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/randombit/botan">botan</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;botan/tls_client.h&gt;
#include &lt;botan/tls_callbacks.h&gt;
#include &lt;botan/tls_session_manager.h&gt;
#include &lt;botan/tls_policy.h&gt;
#include &lt;botan/auto_rng.h&gt;
#include &lt;botan/certstor.h&gt;
#include &lt;botan/certstor_system.h&gt;

// Compliant use the default implementation of tls_verify_cert_chain method which verify server certificate and hostname
class Callbacks : public Botan::TLS::Callbacks
{
// ...
};

class Client_Credentials : public Botan::Credentials_Manager
{
// ...
};

Callbacks callbacks;
Botan::AutoSeeded_RNG rng;
Botan::TLS::Session_Manager_In_Memory session_mgr(rng);
Client_Credentials creds;
Botan::TLS::Strict_Policy policy;

// open the tls connection
Botan::TLS::Client client(callbacks, session_mgr, creds, policy, rng,
                          Botan::TLS::Server_Information("example.com", 443),
                          Botan::TLS::Protocol_Version::TLS_V12); // Compliant; uses an implementation of Botan::TLS::Callbacks that validate server certificate</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP Top 10 2021 Category A2</a> - Cryptographic Failures</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">OWASP Top 10 2021 Category A5</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">OWASP Top 10 2021 Category A7</a> - Identification and Authentication Failures</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A3-Sensitive_Data_Exposure">OWASP Top 10 2017 Category A3</a> - Sensitive Data Exposure</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration">OWASP Top 10 2017 Category A6</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://mobile-security.gitbook.io/masvs/security-requirements/0x10-v5-network_communication_requirements">Mobile AppSec Verification Standard</a> - Network Communication Requirements</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-mobile-top-10/2016-risks/m3-insecure-communication">OWASP Mobile Top 10 2016 Category M3</a> - Insecure Communication</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/295.html">MITRE, CWE-295</a> - Improper Certificate Validation</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Enable server certificate validation on this SSL/TLS connection</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_deprecates_s4424">deprecates: S4424</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s5326">deprecates: S5326</h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s5527">relates to: S5527</h3>

</div>
</div>
</div>