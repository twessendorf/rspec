<div class="paragraph">
<p>Validation of X.509 certificates is essential to create secure SSL/TLS sessions not vulnerable to man-in-the-middle attacks.</p>
</div>
<div class="paragraph">
<p>The certificate chain validation includes these steps:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The certificate is issued by its parent Certificate Authority or the root CA trusted by the system.</p>
</li>
<li>
<p>Each CA is allowed to issue certificates.</p>
</li>
<li>
<p>Each certificate in the chain is not expired.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It&#8217;s not recommended to reinvent the wheel by implementing custom certificate chain validation.</p>
</div>
<div class="paragraph">
<p>TLS libraries provide built-in certificate validation functions that should be used.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>ServicePointManager.ServerCertificateValidationCallback +=
    (sender, certificate, chain, errors) =&gt; {
        return true; // Noncompliant: trust all certificates
    };</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>ServicePointManager.ServerCertificateValidationCallback +=
    (sender, certificate, chain, errors) =&gt;
    {
        if (development) return true; // for development, trust all certificates
        return errors == SslPolicyErrors.None
            &amp;&amp; validCerts.Contains(certificate.GetCertHashString()); // Compliant: trust only some certificates
    };</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP Top 10 2021 Category A2</a> - Cryptographic Failures</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">OWASP Top 10 2021 Category A5</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">OWASP Top 10 2021 Category A7</a> - Identification and Authentication Failures</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A3-Sensitive_Data_Exposure">OWASP Top 10 2017 Category A3</a> - Sensitive Data Exposure</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration">OWASP Top 10 2017 Category A6</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://mobile-security.gitbook.io/masvs/security-requirements/0x10-v5-network_communication_requirements">Mobile AppSec Verification Standard</a> - Network Communication Requirements</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-mobile-top-10/2016-risks/m3-insecure-communication">OWASP Mobile Top 10 2016 Category M3</a> - Insecure Communication</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/295.html">MITRE, CWE-295</a> - Improper Certificate Validation</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Enable server certificate validation on this SSL/TLS connection</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Primary: The update of <code>ServerCertificateValidationCallback</code></p>
</div>
<div class="paragraph">
<p>Secondary: The <code>return true</code> of the function accepting every certificate</p>
</div>
<div class="ulist">
<ul>
<li>
<p>message "This function trusts all certificates."</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_29_oct_2019_112005_alexandre_gigleux_wrote">on 29 Oct 2019, 11:20:05 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>Reference: https://khalidabuhakmeh.com/validating-ssl-certificates-with-dotnet-servicepointmanager</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_6_nov_2019_171801_pavel_mikula_wrote">on 6 Nov 2019, 17:18:01 Pavel Mikula wrote:</h3>
<div class="paragraph">
<p>Few more occurrances of certificate validation procedure:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.httpwebrequest.servercertificatevalidationcallback?view=netframework-4.8" class="bare">https://docs.microsoft.com/en-us/dotnet/api/system.net.httpwebrequest.servercertificatevalidationcallback?view=netframework-4.8</a></p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclienthandler.servercertificatecustomvalidationcallback?view=netframework-4.8" class="bare">https://docs.microsoft.com/en-us/dotnet/api/system.net.http.httpclienthandler.servercertificatecustomvalidationcallback?view=netframework-4.8</a></p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.websockets.clientwebsocketoptions.remotecertificatevalidationcallback?view=netcore-3.0" class="bare">https://docs.microsoft.com/en-us/dotnet/api/system.net.websockets.clientwebsocketoptions.remotecertificatevalidationcallback?view=netcore-3.0</a></p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.security.sslclientauthenticationoptions.remotecertificatevalidationcallback?view=netcore-3.0" class="bare">https://docs.microsoft.com/en-us/dotnet/api/system.net.security.sslclientauthenticationoptions.remotecertificatevalidationcallback?view=netcore-3.0</a></p>
</div>
<div class="paragraph">
<p>And as constructor parameter here:</p>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.security.sslstream.-ctor?view=netframework-4.8" class="bare">https://docs.microsoft.com/en-us/dotnet/api/system.net.security.sslstream.-ctor?view=netframework-4.8</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_oct_2020_161506_marcos_giurni_wrote">on 29 Oct 2020, 16:15:06 Marcos Giurni wrote:</h3>
<div class="paragraph">
<p>The is an error in the compliant solution. The logical operator must be || instead of &amp;&amp;.</p>
</div>
<div class="paragraph">
<p><em>return errors == SslPolicyErrors.None</em></p>
</div>
<div class="literalblock">
<div class="content">
<pre>_{color:#de350b}||{color} validCerts.Contains(certificate.GetCertHashString());_</pre>
</div>
</div>
<div class="paragraph">
<p>Thus, the validation callback will return true if there are no errors (errors == SslPolicyErrors.None) OR if, even with an error, the certificate is in the valid list.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_29_oct_2020_163619_pavel_mikula_wrote">on 29 Oct 2020, 16:36:19 Pavel Mikula wrote:</h3>
<div class="paragraph">
<p>\[~mgiurni] There&#8217;s <code>"trust only some certificates"</code> comment explaining the intention. The validation checks normal errors and from all environment-level trusted certificates it trusts only few selected ones. Probably those that are relevant to given context for extra security.</p>
</div>
<div class="paragraph">
<p>I think the example is correct and we should not promote trusting expired or invalid certificates.</p>
</div>
</div>
<div class="sect2">
<h3 id="_deprecates_s4424">deprecates: S4424</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s5326">deprecates: S5326</h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s5527">relates to: S5527</h3>

</div>
</div>
</div>