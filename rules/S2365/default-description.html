<div class="paragraph">
<p>Most developers expect property access to be as efficient as field access. However, if a property returns a copy of an array or collection, it will be much slower than simple field access, contrary to the caller&#8217;s likely expectations. Therefore, such properties should be refactored into methods so that callers are not surprised by the unexpectedly poor performance.</p>
</div>
<div class="paragraph">
<p>This rule detects calls to <code>ToList</code>, <code>ToArray</code> and array <code>Clone</code>.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>private List&lt;string&gt; _foo = new List&lt;string&gt; { "a", "b", "c" };
public IEnumerable&lt;string&gt; Foo  // Noncompliant
{
    get
    {
        return _foo.ToList();
    }
}

private string[] _bar = new string[] { "a", "b", "c" };
public IEnumerable&lt;string&gt; Bar // Noncompliant
{
    get
    {
        return (string[])_bar.Clone();
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>private List&lt;string&gt; _foo = new List&lt;string&gt; { "a", "b", "c" };
private string[] _bar = new string[] { "a", "b", "c" };

public IEnumerable&lt;string&gt; GetFoo()
{
    return _foo.ToList();
}

public IEnumerable&lt;string&gt; GetBar()
{
    return (string[])_bar.Clone();
}</pre>
</div>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Refactor "xxx" into a method, properties should not copy collections.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>signature</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_13_dec_2016_133205_valeri_hristov_wrote">on 13 Dec 2016, 13:32:05 Valeri Hristov wrote:</h3>
<div class="paragraph">
<p>The root problem that we are trying to solve with this rule is not the performance hit when copying an array, but the wrong assumption that the Array is an immutable data structure (it is not). Deep cloning an array could be used to achieve immutability of the collection, hence the performance problem.</p>
</div>
<div class="paragraph">
<p>A very good explanation why you should not return, or actually use arrays, unless you have to:</p>
</div>
<div class="paragraph">
<p><a href="https://blogs.msdn.microsoft.com/ericlippert/2008/09/22/arrays-considered-somewhat-harmful/" class="bare">https://blogs.msdn.microsoft.com/ericlippert/2008/09/22/arrays-considered-somewhat-harmful/</a></p>
</div>
<div class="paragraph">
<p>\[~ann.campbell.2] could you have a look at this?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_dec_2016_144936_ann_campbell_wrote">on 15 Dec 2016, 14:49:36 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Per our discussion [~valeri.hristov], I&#8217;m going to leave this along for now pending the decision on whether to expand the scope of the rule to <em>all</em> arrays.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_9_mar_2017_100416_amaury_levé_wrote">on 9 Mar 2017, 10:04:16 Amaury Levé wrote:</h3>
<div class="paragraph">
<p>The article and the Fxcop rules are actually covering two things:</p>
</div>
<div class="paragraph">
<p>1/ A design issue where <code>arrays</code> are mutable and so you might have unexpected behaviors.</p>
</div>
<div class="paragraph">
<p>2/ A performance issue when calling a property/method returning an array because the developer might be doing a copy (shallow or deep) of the array he is about to return.</p>
</div>
<div class="paragraph">
<p>Point #1 is easy to cover and my feeling is that this rule should become: <code>Arrays should not be used as the return type of a public method or property</code>. About the description, I would say that developers tend to think an <code>Array</code> is immutable and therefore they won&#8217;t anticipate the data can change over calls. I won&#8217;t even specify exception cases because if the developer knows what he is doing then he is smart enough to mark the issue as <code>won't fix</code>.</p>
</div>
<div class="paragraph">
<p>Point #2 might be partially covered by recommending to the developer to convert the <code>property</code> to a <code>method</code> when there is some kind of copy in it.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_13_mar_2017_162127_ann_campbell_wrote">on 13 Mar 2017, 16:21:27 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Updated per our discussion [~amaury.leve] and [~valeri.hristov]. Please double-check me.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_13_mar_2017_163103_valeri_hristov_wrote">on 13 Mar 2017, 16:31:03 Valeri Hristov wrote:</h3>
<div class="paragraph">
<p>LGTM, changed the message a bit</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_apr_2017_162107_valeri_hristov_wrote">on 12 Apr 2017, 16:21:07 Valeri Hristov wrote:</h3>
<div class="paragraph">
<p>Here are a few ways to copy a collection or an array:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>collection.ToList()
collection.ToArray()
array.Clone()
array.Copy()
array.CopyTo()
new List&lt;T&gt;(collection)
new HashSet&lt;T&gt;(collection)
... 10s of other collection types too, except ReadOnlyCollection&lt;T&gt; which keeps a reference to the original
new MyList(collection)</pre>
</div>
</div>
<div class="paragraph">
<p>This is a case which should not raise an issue (which has many variations):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public string[] FemaleNames
{
    get
    {
        if (femaleNames == null)
        {
            femaleNames = names.Where(IsFemale).ToArray();
        }
        return femaleNames;
    }
}</pre>
</div>
</div>
</div>
</div>
</div>