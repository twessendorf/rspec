<div class="paragraph">
<p>Applications that allow execution of operating system commands from user-controlled data should control the command to execute, otherwise an attacker can inject arbitrary commands that will compromise the underlying operating system.</p>
</div>
<div class="paragraph">
<p>The mitigation strategy can be based on a list of authorized and safe commands to execute and when a shell is spawned to sanitize shell meta-characters. Keep in mind that when a single argument to the command is user-controlled and shell-metachars are sanitized, it can still lead to vulnerabilities if the attacker can inject a dangerous option supported by the command, such as <code>-exec</code> available with <a href="https://linux.die.net/man/1/find">find</a>, in that case, mark end of option processing on the command line using <code>--</code> (double-dash) or restrict options to only trusted values.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>import java.io.IOException;
import javax.servlet.http.HttpServletRequest;

public void runUnsafe(HttpServletRequest request) throws IOException {
  String cmd = request.getParameter("command");
  String arg = request.getParameter("arg");

  Runtime.getRuntime().exec(cmd+" "+arg); // Noncompliant
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Implement an allow-list of authorized commands to execute:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>each time the command to execute is user-controlled:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>import java.io.IOException;
import javax.servlet.http.HttpServletRequest;

public void runUnsafe(HttpServletRequest request) throws IOException {
  String cmd = request.getParameter("command");
  String arg = request.getParameter("arg");

  if(cmd.equals("/usr/bin/ls") || cmd.equals("/usr/bin/cat"))
  {
       // only ls or cat command are authorized
       String cmdarray[] =  new String[] { cmd, arg };
       Runtime.getRuntime().exec(cmdarray); // Compliant
  }
}</pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>or globally with the creation of a SecurityManager overriding checkExec() method:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre>class MySecurityManager extends SecurityManager {
  MySecurityManager() {
    super();
  }

  public void checkExec(String cmd) {
    if(!(cmd.equals("/usr/bin/ls") || cmd.equals("/usr/bin/cat"))) {
      throw new SecurityException("Unauthorized command: "+cmd);
    }
  }
}</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>MySecurityManager sm = new MySecurityManager();
System.setSecurityManager(sm);</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p>OWASP OS Command Injection Defense <a href="https://cheatsheetseries.owasp.org/cheatsheets/OS_Command_Injection_Defense_Cheat_Sheet.html">Cheat Sheet</a></p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/78.html">MITRE, CWE-78</a> - Improper Neutralization of Special Elements used in an OS Command</p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat1">SANS Top 25</a> - Insecure Interaction Between Components</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct the OS command from user-controlled data.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s4721">is related to: S4721</h3>

</div>
<div class="sect2">
<h3 id="_on_9_apr_2015_184102_ann_campbell_wrote">on 9 Apr 2015, 18:41:02 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Applies to JavaScript via HTML5</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_26_apr_2018_174916_ann_campbell_wrote">on 26 Apr 2018, 17:49:16 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~dinesh.bolkensteyn] this rule is implemented for ABAP, &amp; that description content you just dropped probably still applies there&#8230;&#8203;</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_27_apr_2018_203622_ann_campbell_wrote">on 27 Apr 2018, 20:36:22 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~dinesh] we do trac CERT references (there&#8217;s even a field for that! :)). Feel free to add the reference you found.</p>
</div>
</div>
</div>
</div>