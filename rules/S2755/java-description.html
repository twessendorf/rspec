<div class="paragraph">
<p>XML standard allows the use of entities, declared in the DOCTYPE of the document, which can be <a href="https://www.w3.org/TR/xml/#sec-internal-ent">internal</a> or <a href="https://www.w3.org/TR/xml/#sec-external-ent">external</a>.</p>
</div>
<div class="paragraph">
<p>When parsing the XML file, the content of the external entities is retrieved from an external storage such as the file system or network, which may lead, if no restrictions are put in place, to arbitrary file disclosures or <a href="https://www.owasp.org/index.php/Server_Side_Request_Forgery">server-side request forgery (SSRF)</a> vulnerabilities.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;!DOCTYPE person [
  &lt;!ENTITY file SYSTEM "file:///etc/passwd"&gt;
  &lt;!ENTITY ssrf SYSTEM "https://internal.network/sensitive_information"&gt;
]&gt;

&lt;person&gt;
  &lt;name&gt;&amp;file;&lt;/name&gt;
  &lt;city&gt;&amp;ssrf;&lt;/city&gt;
  &lt;age&gt;18&lt;/age&gt;
&lt;/person&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>It&#8217;s recommended to limit resolution of external entities by using one of these solutions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If DOCTYPE is not necessary, completely disable all DOCTYPE declarations.</p>
</li>
<li>
<p>If external entities are not necessary, completely disable their declarations.</p>
</li>
<li>
<p>If external entities are necessary then:</p>
<div class="ulist">
<ul>
<li>
<p>Use XML processor features, if available, to authorize only required protocols (eg: https).</p>
</li>
<li>
<p>And use an entity resolver (and optionally an XML Catalog) to resolve only trusted entities.
== Noncompliant Code Example</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>For <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/parsers/DocumentBuilderFactory.html">DocumentBuilder</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/parsers/SAXParserFactory.html">SAXParser</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/stream/XMLInputFactory.html">XMLInput</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/transform/TransformerFactory.html">Transformer</a> and <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/validation/SchemaFactory.html">Schema</a> JAPX factories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance(); // Noncompliant

SAXParserFactory factory = SAXParserFactory.newInstance(); // Noncompliant

XMLInputFactory factory = XMLInputFactory.newInstance(); // Noncompliant

TransformerFactory factory = javax.xml.transform.TransformerFactory.newInstance();  // Noncompliant

SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);  // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://dom4j.github.io/">Dom4j</a> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SAXReader xmlReader = new SAXReader(); // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="http://www.jdom.org/">Jdom2</a> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SAXBuilder builder = new SAXBuilder(); // Noncompliant</pre>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>For <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/parsers/DocumentBuilderFactory.html">DocumentBuilder</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/parsers/SAXParserFactory.html">SAXParser</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/stream/XMLInputFactory.html">XMLInput</a>, <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/transform/TransformerFactory.html">Transformer</a> and <a href="https://docs.oracle.com/javase/9/docs/api/javax/xml/validation/SchemaFactory.html">Schema</a> JAPX factories:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
// to be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
// or completely disable external entities declarations:
factory.setFeature("http://xml.org/sax/features/external-general-entities", false);
factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
// or prohibit the use of all protocols by external entities:
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");


SAXParserFactory factory = SAXParserFactory.newInstance();
// to be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
// or completely disable external entities declarations:
factory.setFeature("http://xml.org/sax/features/external-general-entities", false);
factory.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
// or prohibit the use of all protocols by external entities:
SAXParser parser = factory.newSAXParser(); // Noncompliant
parser.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
parser.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");

XMLInputFactory factory = XMLInputFactory.newInstance();
// to be compliant, completely disable DOCTYPE declaration:
factory.setProperty(XMLInputFactory.SUPPORT_DTD, false);
// or completely disable external entities declarations:
factory.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES, Boolean.FALSE);
// or prohibit the use of all protocols by external entities:
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");

TransformerFactory factory = javax.xml.transform.TransformerFactory.newInstance();
// to be compliant, prohibit the use of all protocols by external entities:
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, "");

SchemaFactory factory = SchemaFactory.newInstance(XMLConstants.W3C_XML_SCHEMA_NS_URI);
// to be compliant, completely disable DOCTYPE declaration:
factory.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);
// or prohibit the use of all protocols by external entities:
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
factory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="https://dom4j.github.io/">Dom4j</a> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SAXReader xmlReader = new SAXReader();
xmlReader.setFeature("http://apache.org/xml/features/disallow-doctype-decl", true);</pre>
</div>
</div>
<div class="paragraph">
<p>For <a href="http://www.jdom.org/">Jdom2</a> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>SAXBuilder builder = new SAXBuilder();
builder.setProperty(XMLConstants.ACCESS_EXTERNAL_DTD, "");
builder.setProperty(XMLConstants.ACCESS_EXTERNAL_SCHEMA, "");</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">OWASP Top 10 2021 Category A5</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://docs.oracle.com/en/java/javase/13/security/java-api-xml-processing-jaxp-security-guide.html#GUID-8CD65EF5-D113-4D5C-A564-B875C8625FAC">Oracle Java Documentation</a> - XML External Entity Injection Attack</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A4-XML_External_Entities_(XXE)">OWASP Top 10 2017 Category A4</a> - XML External Entities (XXE)</p>
</li>
<li>
<p><a href="https://cheatsheetseries.owasp.org/cheatsheets/XML_External_Entity_Prevention_Cheat_Sheet.html#java">OWASP XXE Prevention Cheat Sheet</a></p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/611.html">MITRE, CWE-611</a> - Information Exposure Through XML External Entity Reference</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/827.html">MITRE, CWE-827</a> - Improper Control of Document Type Definition</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Disable access to external entities in XML parsing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>Java: Instantiation of the XMLInputFactory or SAXParserFactory or XMLReader or DocumentBuilderFactory or DocumentBuilder object</p>
</div>
<div class="paragraph">
<p>Primary: where the xml parsing is done / incorrect options are used</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Secondary: where the xml option enable external entities</p>
<div class="ulist">
<ul>
<li>
<p>message: "This value enables external entities in XML parsing."</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_deprecates_s4435">deprecates: S4435</h3>

</div>
<div class="sect2">
<h3 id="_on_23_mar_2015_195642_ann_campbell_wrote">on 23 Mar 2015, 19:56:42 Ann Campbell wrote:</h3>
<div class="paragraph">
<p><a href="https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing" class="bare">https://www.owasp.org/index.php/XML_External_Entity_%28XXE%29_Processing</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_20_jul_2015_073417_ann_campbell_wrote">on 20 Jul 2015, 07:34:17 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Tagged java-top by Ann [~nicolas.peru]</p>
</div>
</div>
</div>
</div>