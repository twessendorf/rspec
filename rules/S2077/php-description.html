<div class="paragraph">
<p>Formatted SQL queries can be difficult to maintain, debug and can increase the risk of SQL injection when concatenating untrusted values into the query. However, this rule doesn&#8217;t detect SQL injections (unlike rule S3649), the goal is only to highlight complex/formatted queries.</p>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Some parts of the query come from untrusted values (like user inputs).</p>
</li>
<li>
<p>The query is repeated/duplicated in other parts of the code.</p>
</li>
<li>
<p>The application must support different types of relational databases.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered yes to any of those questions.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Use <a href="https://www.owasp.org/index.php/Query_Parameterization_Cheat_Sheet">parameterized queries, prepared statements, or stored procedures</a> and bind variables to SQL query parameters.</p>
</li>
<li>
<p>Consider using ORM frameworks if there is a need to have an abstract layer to access data.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$id = $_GET['id'];
mysql_connect('localhost', $username, $password) or die('Could not connect: ' . mysql_error());
mysql_select_db('myDatabase') or die('Could not select database');

$result = mysql_query("SELECT * FROM myTable WHERE id = " . $id);  // Sensitive, could be susceptible to SQL injection

while ($row = mysql_fetch_object($result)) {
    echo $row-&gt;name;
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>$id = $_GET['id'];
try {
    $conn = new PDO('mysql:host=localhost;dbname=myDatabase', $username, $password);
    $conn-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

    $stmt = $conn-&gt;prepare('SELECT * FROM myTable WHERE id = :id');
    $stmt-&gt;execute(array('id' =&gt; $id));

    while($row = $stmt-&gt;fetch(PDO::FETCH_OBJ)) {
        echo $row-&gt;name;
    }
} catch(PDOException $e) {
    echo 'ERROR: ' . $e-&gt;getMessage();
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>No issue will be raised if one of the functions is called with hard-coded string (no concatenation) and this string does not contain a "$" sign.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$result = mysql_query("SELECT * FROM myTable WHERE id = 42") or die('Query failed: ' . mysql_error());  // Compliant</pre>
</div>
</div>
<div class="paragraph">
<p>The current implementation does not follow variables. It will only detect SQL queries which are concatenated or contain a <code>$</code> sign directly in the function call.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$query = "SELECT * FROM myTable WHERE id = " . $id;
$result = mysql_query($query);  // No issue will be raised even if it is Sensitive</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/89.html">MITRE, CWE-89</a> - Improper Neutralization of Special Elements used in an SQL Command</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/564.html">MITRE, CWE-564</a> - SQL Injection: Hibernate</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/943.html">MITRE, CWE-943</a> - Improper Neutralization of Special Elements in Data Query Logic</p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat1">SANS Top 25</a> - Insecure Interaction Between Components</p>
</li>
<li>
<p>Derived from FindSecBugs rules <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JPA">Potential SQL/JPQL Injection (JPA)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_JDO">Potential SQL/JDOQL Injection (JDO)</a>, <a href="https://h3xstream.github.io/find-sec-bugs/bugs.htm#SQL_INJECTION_HIBERNATE">Potential SQL/HQL Injection (Hibernate)</a></p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Make sure using a dynamically formatted SQL query is safe here.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="ulist">
<ul>
<li>
<p>Primary: on the sql query call</p>
</li>
<li>
<p>Secondary: on each assignment / format of the query</p>
<div class="ulist">
<ul>
<li>
<p>message when formatting: "SQL Query is dynamically formatted and assigned to {variable_name}"</p>
</li>
<li>
<p>message for an assignment: "SQL query is assigned to {variable_name}"</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_27_jul_2015_123752_ann_campbell_wrote">on 27 Jul 2015, 12:37:52 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Ref: http://code.tutsplus.com/tutorials/php-database-access-are-you-doing-it-correctly&#8212;&#8203;net-25338</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_27_jul_2015_123813_ann_campbell_wrote">on 27 Jul 2015, 12:38:13 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>back to you for double-checking [~alexandre.gigleux]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_1_sep_2016_144821_alexandre_gigleux_wrote">on 1 Sep 2016, 14:48:21 Alexandre Gigleux wrote:</h3>
<div class="paragraph">
<p>LGTM</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_22_oct_2018_133030_nicolas_harraudeau_wrote">on 22 Oct 2018, 13:30:30 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p><strong>Implementation details</strong>:</p>
</div>
<div class="paragraph">
<p>The functions listed above don&#8217;t support prepared statements, thus the only way to provide parameters is to concatenate strings. An issue will be created if it cannot be proven that the SQL string is hardcoded. For example an issue will be created if the SQL string is provided as a variable to the current method. If on the contrary the variable is local to the method and is assigned a hard-coded string there will be no issue raised.</p>
</div>
<div class="paragraph">
<p>For other functions which support prepared statement, the default behavior should be inverted. If the string cannot be proven to be concatenated there is no issue. Thus no issue will be created if the SQL string is provided as a variable to the current method.</p>
</div>
</div>
<div class="sect2">
<h3 id="_is_duplicated_by_s3371">is duplicated by: S3371</h3>

</div>
<div class="sect2">
<h3 id="_relates_to_s3649">relates to: S3649</h3>

</div>
<div class="sect2">
<h3 id="_replaces_s1877">replaces: S1877</h3>

</div>
<div class="sect2">
<h3 id="_on_12_oct_2014_164756_freddy_mallet_wrote">on 12 Oct 2014, 16:47:56 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>@Ann, I would associate this rule to Findbugs rules : SQL_NONCONSTANT_STRING_PASSED_TO_EXECUTE,SQL_PREPARED_STATEMENT_GENERATED_FROM_NONCONSTANT_STRING</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_12_nov_2014_154127_sébastien_gioria_wrote">on 12 Nov 2014, 15:41:27 Sébastien Gioria wrote:</h3>
<div class="paragraph">
<p>May I suggest to setup default severity as "Blocker" ? We should not find anymore Dynamic query in the source code without sanitizing.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_152202_freddy_mallet_wrote">on 21 Nov 2014, 15:22:02 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>Fine for me [~ann.campbell.2] and [~sebastien.gioria] to increase the severity to "Blocker"</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_21_nov_2014_173303_ann_campbell_wrote">on 21 Nov 2014, 17:33:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~freddy.mallet] I considered this, but our guidelines specifically say SQL Injection rules should be Critical. Guess I should have annotated the ticket accordingly. :-/</p>
</div>
<div class="paragraph">
<p>cc [~sebastien.gioria]</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_24_may_2016_131314_ann_campbell_wrote">on 24 May 2016, 13:13:14 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>ABAP reference: https://www.kiuwan.com/blog/security-business-oriented-languages-abap/</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_26_may_2016_114421_nicolas_bontoux_wrote">on 26 May 2016, 11:44:21 Nicolas Bontoux wrote:</h3>
<div class="paragraph">
<p>PL/SQL reference <a href="https://oracle-base.com/articles/misc/literals-substitution-variables-and-bind-variables">here</a> . Note that for PL/SQL this best practice is not just about security, there&#8217;s also a performance impact (soft/hard parsing logic).</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2016_155430_freddy_mallet_wrote">on 16 Jun 2016, 15:54:30 Freddy Mallet wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] there is a huge difference between the two rules :</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In PL/SQL, when using Literals or Substitution Variables there is absolutely no risk to change the structure of the SQL request to do something which is not expected &#8594; so we absolutely don&#8217;t care about the content of literal or substitution variables and a so about the fact that those values should be sanitized. The only overlap between the two rules is the remediation action but the purpose is absolutely not the same</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2016_134852_ann_campbell_wrote">on 17 Jun 2016, 13:48:52 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>To close the thread, we&#8217;ll leave PL/SQL here</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_19_sep_2018_151219_nicolas_harraudeau_wrote">on 19 Sep 2018, 15:12:19 Nicolas Harraudeau wrote:</h3>
<div class="paragraph">
<p>This rule becomes a Hotspot. The corresponding vulnerability is  RSPEC-3649.</p>
</div>
</div>
</div>
</div>