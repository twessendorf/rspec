<div class="paragraph">
<p>User provided data, such as URL parameters, should always be considered untrusted and tainted. Constructing SQL queries directly from tainted data enables attackers to inject specially crafted values that change the initial meaning of the query itself. Successful database query injection attacks can read, modify, or delete sensitive information from the database and sometimes even shut it down or execute arbitrary operating system commands.</p>
</div>
<div class="paragraph">
<p>Typically, the solution is to use prepared statements and to bind variables to SQL query parameters with dedicated methods like <code>setParameter</code>, which ensures that user provided data will be properly escaped. Another solution is to validate every parameter used to build the query. This can be achieved by transforming string values to primitive types or by validating them against a white list of accepted values.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApplication1.Controllers;

namespace WebApplicationDotNetCore.Controllers
{
    public class RSPEC3649SQLiNoncompliant : Controller
    {
        private readonly UserAccountContext _context;

        public RSPEC3649SQLiNoncompliant(UserAccountContext context)
        {
            _context = context;
        }

        public IActionResult Authenticate(string user)
        {
            string query = "SELECT * FROM Users WHERE Username = '" + user + "'";

            // an attacker can bypass authentication by setting user to this special value
            // user = "' or 1=1 or ''='";

            var userExists = false;
            if (_context.Database.ExecuteSqlCommand(query) &gt; 0) // Noncompliant
            {
                userExists = true;
            }

            return Content(userExists ? "success" : "fail");
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>using Microsoft.AspNetCore.Mvc;
using Microsoft.EntityFrameworkCore;
using WebApplication1.Controllers;

namespace WebApplicationDotNetCore.Controllers
{
    public class RSPEC3649SQLiCompliant : Controller
    {
        private readonly UserAccountContext _context;

        public RSPEC3649SQLiCompliant(UserAccountContext context)
        {
            _context = context;
        }

        public IActionResult Authenticate(string user)
        {
            var query = "SELECT * FROM Users WHERE Username = {0}"; // Safe

            var userExists = false;
            if  (_context.Database.ExecuteSqlCommand(query, user) &gt; 0)
            {
                userExists = true;
            }

            return Content(userExists ? "success" : "fail");
        }
    }
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/89.html">MITRE, CWE-89</a> - Improper Neutralization of Special Elements used in an SQL Command</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/564.html">MITRE, CWE-564</a> - SQL Injection: Hibernate</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/943.html">MITRE, CWE-943</a> - Improper Neutralization of Special Elements in Data Query Logic</p>
</li>
<li>
<p>OWASP SQL Injection Prevention <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">Cheat Sheet</a></p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat1">SANS Top 25</a> - Insecure Interaction Between Components</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct database queries directly from user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2077">is related to: S2077</h3>

</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_145158_amaury_levé_wrote">on 30 Jun 2017, 14:51:58 Amaury Levé wrote:</h3>
<div class="paragraph">
<p>Could you create the sub-task with all the cases described in the fxcop page?</p>
</div>
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/en-us/library/ms182310.aspx" class="bare">https://msdn.microsoft.com/en-us/library/ms182310.aspx</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_151029_jean_christophe_collet_wrote">on 30 Jun 2017, 15:10:29 Jean-Christophe Collet wrote:</h3>
<div class="paragraph">
<p>Done</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_193103_ann_campbell_wrote">on 5 Apr 2018, 19:31:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~dinesh.bolkensteyn] all commentary should be concentrated in the description, not distributed throughout the code samples as well. I suggest something like</p>
</div>
<div class="paragraph">
<p><em><em>_Tainted data should be sanitized before use by for instance using prepared statements instead of concatenation.</em>_</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_195820_dinesh_bolkensteyn_wrote">on 5 Apr 2018, 19:58:20 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>Thanks [~ann.campbell.2] Could you please check again &amp; directly update this RSPEC if there are further things to improve?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_202712_ann_campbell_wrote">on 5 Apr 2018, 20:27:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Looks good [~dinesh.bolkensteyn]</p>
</div>
</div>
</div>
</div>