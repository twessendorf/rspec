<div class="paragraph">
<p>User provided data, such as URL parameters, should always be considered untrusted and tainted. Constructing SQL queries directly from tainted data enables attackers to inject specially crafted values that change the initial meaning of the query itself. Successful database query injection attacks can read, modify, or delete sensitive information from the database and sometimes even shut it down or execute arbitrary operating system commands.</p>
</div>
<div class="paragraph">
<p>Typically, the solution is to use prepared statements and to bind variables to SQL query parameters with dedicated methods like <code>params</code>, which ensures that user provided data will be properly escaped. Another solution is to validate every parameter used to build the query. This can be achieved by transforming string values to primitive types or by validating them against a white list of accepted values.</p>
</div>
<div class="paragraph">
<p>This rule supports: sqlite3, mysql, pymysql, psycopg2, pgdb, Django ORM and Flask-SQLAlchemy.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Flask application</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from flask import request
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import text
from database.users import User

@app.route('hello')
def hello():
    id = request.args.get("id")
    stmt = text("SELECT * FROM users where id=%s" % id) # Query is constructed based on user inputs
    query = SQLAlchemy().session.query(User).from_statement(stmt) # Noncompliant
    user = query.one()
    return "Hello %s" % user.username</pre>
</div>
</div>
<div class="paragraph">
<p>Django application</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from django.http import HttpResponse
from django.db import connection

def hello(request):
    id = request.GET.get("id", "")
    cursor = connection.cursor()
    cursor.execute("SELECT username FROM auth_user WHERE id=%s" % id) # Noncompliant; Query is constructed based on user inputs
    row = cursor.fetchone()
    return HttpResponse("Hello %s" % row[0])</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Flask application</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from flask import request
from flask_sqlalchemy import SQLAlchemy
from sqlalchemy import text
from database.users import User

@app.route('hello')
def hello():
    id = request.args.get("id")
    stmt = text("SELECT * FROM users where id=:id")
    query = SQLAlchemy().session.query(User).from_statement(stmt).params(id=id) # Compliant
    user = query.one()
    return "Hello %s" % user.username</pre>
</div>
</div>
<div class="paragraph">
<p>Django application</p>
</div>
<div class="listingblock">
<div class="content">
<pre>from django.http import HttpResponse
from django.db import connection

def hello(request):
    id = request.GET.get("id", "")
    cursor = connection.cursor()
    cursor.execute("SELECT username FROM auth_user WHERE id=:id", {"id": id}) # Compliant
    row = cursor.fetchone()
    return HttpResponse("Hello %s" % row[0])</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="_see_2">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A03_2021-Injection/">OWASP Top 10 2021 Category A3</a> - Injection</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A1-Injection">OWASP Top 10 2017 Category A1</a> - Injection</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/20.html">MITRE, CWE-20</a> - Improper Input Validation</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/89.html">MITRE, CWE-89</a> - Improper Neutralization of Special Elements used in an SQL Command</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/943.html">MITRE, CWE-943</a> - Improper Neutralization of Special Elements in Data Query Logic</p>
</li>
<li>
<p>OWASP SQL Injection Prevention <a href="https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html">Cheat Sheet</a></p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat1">SANS Top 25</a> - Insecure Interaction Between Components</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Change this code to not construct database queries directly from user-controlled data.</p>
</div>
</div>
<div class="sect2">
<h3 id="_highlighting">Highlighting</h3>
<div class="paragraph">
<p>"[varname]" is tainted (assignments and parameters)</p>
</div>
<div class="paragraph">
<p>this argument is tainted (method invocations)</p>
</div>
<div class="paragraph">
<p>the returned value is tainted (returns &amp; method invocations results)</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_is_related_to_s2077">is related to: S2077</h3>

</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_145158_amaury_levé_wrote">on 30 Jun 2017, 14:51:58 Amaury Levé wrote:</h3>
<div class="paragraph">
<p>Could you create the sub-task with all the cases described in the fxcop page?</p>
</div>
<div class="paragraph">
<p><a href="https://msdn.microsoft.com/en-us/library/ms182310.aspx" class="bare">https://msdn.microsoft.com/en-us/library/ms182310.aspx</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_30_jun_2017_151029_jean_christophe_collet_wrote">on 30 Jun 2017, 15:10:29 Jean-Christophe Collet wrote:</h3>
<div class="paragraph">
<p>Done</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_193103_ann_campbell_wrote">on 5 Apr 2018, 19:31:03 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~dinesh.bolkensteyn] all commentary should be concentrated in the description, not distributed throughout the code samples as well. I suggest something like</p>
</div>
<div class="paragraph">
<p><em><em>_Tainted data should be sanitized before use by for instance using prepared statements instead of concatenation.</em>_</em></p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_195820_dinesh_bolkensteyn_wrote">on 5 Apr 2018, 19:58:20 Dinesh Bolkensteyn wrote:</h3>
<div class="paragraph">
<p>Thanks [~ann.campbell.2] Could you please check again &amp; directly update this RSPEC if there are further things to improve?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_5_apr_2018_202712_ann_campbell_wrote">on 5 Apr 2018, 20:27:12 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Looks good [~dinesh.bolkensteyn]</p>
</div>
</div>
</div>
</div>