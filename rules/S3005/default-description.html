<div class="paragraph">
<p>When a non-<code>static</code> class field is annotated with <code>ThreadStatic</code>, the code seems to show that the field can have different values for different calling threads, but that&#8217;s not the case, since the <code>ThreadStatic</code> attribute is simply ignored on non-<code>static</code> fields.</p>
</div>
<div class="paragraph">
<p>So <code>ThreadStatic</code> should either be removed or replaced with a use of the <code>ThreadLocal&lt;T&gt;</code> class, which gives a similar behavior for non-<code>static</code> fields.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>public class MyClass
{
  [ThreadStatic]  // Noncompliant
  private int count = 0;

  // ...
}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>public class MyClass
{
  private int count = 0;

  // ...
}</pre>
</div>
</div>
<div class="paragraph">
<p>or</p>
</div>
<div class="listingblock">
<div class="content">
<pre>public class MyClass
{
  private readonly ThreadLocal&lt;int&gt; count = new ThreadLocal&lt;int&gt;();
  public int Count
  {
    get { return count.Value; }
    set { count.Value = value; }
  }
  // ...
}</pre>
</div>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Remove the "ThreadStatic" attribute from this definition.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_8_jun_2015_084339_tamas_vajk_wrote">on 8 Jun 2015, 08:43:39 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>LGTM</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_123935_tamas_vajk_wrote">on 15 Jun 2015, 12:39:35 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Based on [~dinesh.bolkensteyn]'s comments I&#8217;ve changed the description a bit. Also, with this wording it is more like a bug than a maintainability issue. So I&#8217;ve modified the severity as well. I didn&#8217;t change the SQALE characteristic, do you see any better option?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_jun_2015_150319_ann_campbell_wrote">on 15 Jun 2015, 15:03:19 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] as written, 'Critical' is not currently appropriate for this rule. If we&#8217;re going to increase the severity, then the description needs to show why it&#8217;s 'Critical'. What mistakes will this misunderstanding have lead the developer to make?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2015_091533_tamas_vajk_wrote">on 16 Jun 2015, 09:15:33 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I&#8217;ve updated the description to be more bug-oriented.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_16_jun_2015_111719_ann_campbell_wrote">on 16 Jun 2015, 11:17:19 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~tamas.vajk] my 5 minutes with Google did not reveal the significance of <code>ThreadLocal</code>. How is it relevant here?</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2015_071629_tamas_vajk_wrote">on 17 Jun 2015, 07:16:29 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] I can understand that you couldn&#8217;t find a lot of info on <code>ThreadLocal</code>. It is only part of .Net 4, and it is probably rarely used.</p>
</div>
<div class="paragraph">
<p>If you have a <code>ThreadStatic</code> non-<code>static</code> field, that behaves as a normal non-<code>static</code> field. So the attribute is useless on it. You should remove it (first compliant solution). But what if you want a non-<code>static</code> field that can store different values based on the thread we are using it from. Then you can use the <code>ThreadLocal</code> class (second complaint solution).</p>
</div>
<div class="paragraph">
<p>Check out the below code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>var m1 = new MyClass();
var m2 = new MyClass();
m1.Count = 5;
m2.Count = 7;

Task.Factory.StartNew(() =&gt;
{
    m1.Count = 6;
    m2.Count = 8;
    Console.WriteLine(m1.Count);
    Console.WriteLine(m2.Count);
}).Wait();

Console.WriteLine(m1.Count);
Console.WriteLine(m2.Count);</pre>
</div>
</div>
<div class="paragraph">
<p>It writes to the console <code>6,8,5,7</code>. We have two instances of <code>MyClass</code>, we set the <code>Count</code> to different values (the field is not static). Then start a new thread, and set the <code>Count</code> again to different values. In the new thread and in the main thread the <code>Count</code>s have different values even for the same objects.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2015_125037_ann_campbell_wrote">on 17 Jun 2015, 12:50:37 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>Okay, your turn [~tamas.vajk]. :-)</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_17_jun_2015_131358_tamas_vajk_wrote">on 17 Jun 2015, 13:13:58 Tamas Vajk wrote:</h3>
<div class="paragraph">
<p>\[~ann.campbell.2] Thanks, it looks good, I&#8217;ll run it through [~dinesh.bolkensteyn], and we&#8217;ll see what he thinks.</p>
</div>
</div>
</div>
</div>