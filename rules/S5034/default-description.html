<div class="paragraph">
<p><code>ValueTask&lt;TResult&gt;</code> was introduced in .NET Core 2.0 <a href="https://devblogs.microsoft.com/dotnet/understanding-the-whys-whats-and-whens-of-valuetask/">to optimize memory allocation</a> when functions return their results synchronously.</p>
</div>
<div class="paragraph">
<p><code>ValueTask</code> and <code>ValueTask&lt;TResult&gt;</code> should <strong>never</strong> be used in the following ways as it could result in a race condition:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Calling <code>await</code> multiple times on a <code>ValueTask / ValueTask&lt;TResult&gt;</code>*. The wrapped object may have been reused by another operation. This differs from <code>Task / Task&lt;TResult&gt;</code>, on which you can await multiple times and always get the same result.</p>
</li>
<li>
<p>Calling <code>await</code> concurrently on a <code>ValueTask / ValueTask&lt;TResult&gt;</code>*. The underlying object is not thread safe. What&#8217;s more, it has the same effect as awaiting multiple times a <code>ValueTask / ValueTask&lt;TResult&gt;</code>. This again differs from <code>Task / Task&lt;TResult&gt;</code>, which support concurrent <code>await</code>.</p>
</li>
<li>
<p>Using <code>.Result</code> or <code>.GetAwaiter().GetResult()</code> without checking if the operation completed*. <code>IValueTaskSource / IValueTaskSource&lt;TResult&gt;</code> implementations are not required to block until the operation completes. On the other hand, <code>Task / Task&lt;TResult&gt;</code> blocks the call until the task completes.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is recommended to use <code>ValueTask / ValueTask&lt;TResult&gt;</code> either by calling "await" on the function returning it, optionally calling <code>ConfigureAwait(false)</code> on it, or by calling <code>.AsTask()</code> on it.</p>
</div>
<div class="paragraph">
<p>This rule raises an issue when the following operations are performed on a <code>ValueTask / ValueTask&lt;TResult&gt;</code> instance:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Awaiting the instance multiple times.</p>
</li>
<li>
<p>Calling <code>AsTask</code> multiple times.</p>
</li>
<li>
<p>Using <code>.Result</code> or <code>.GetAwaiter().GetResult()</code> multiple times</p>
</li>
<li>
<p>Using <code>.Result</code> or <code>.GetAwaiter().GetResult()</code> when the operation has not yet completed</p>
</li>
<li>
<p>Using more than one of these ways to consume the instance.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync();
int result = await vt;
int result2 = await vt; // Noncompliant, variable is awaited multiple times

int value = SomeValueTaskReturningMethodAsync().GetAwaiter().GetResult(); // Noncompliant, uses GetAwaiter().GetResult() when it's not known to be done</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>int result = await SomeValueTaskReturningMethodAsync();

int result = await SomeValueTaskReturningMethodAsync().ConfigureAwait(false);

Task&lt;int&gt; t = SomeValueTaskReturningMethodAsync().AsTask();</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This rule does not raise any issue when a <code>ValueTask / ValueTask&lt;TResult&gt;</code> is awaited multiple time in a loop.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.valuetask-1">ValueTask&lt;TResult&gt; official documentation</a></p>
</li>
<li>
<p><a href="https://blogs.msdn.microsoft.com/dotnet/2018/11/07/understanding-the-whys-whats-and-whens-of-valuetask/">Understanding the Whys, Whats, and Whens of ValueTask</a></p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Refactor this <code>ValueTask</code> usage to await it once or call <code>AsTask()</code>.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_13_sep_2019_160118_andrei_epure_wrote">on 13 Sep 2019, 16:01:18 Andrei Epure wrote:</h3>
<div class="paragraph">
<p>According to <a href="https://docs.microsoft.com/en-us/dotnet/api/system.threading.tasks.valuetask-1?view=netstandard-2.1">the docs</a> "The use of the ValueTask type is supported starting with C# 7.0, and is not supported by any version of Visual Basic.", thus I am removing VB from this</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_13_sep_2019_160919_andrei_epure_wrote">on 13 Sep 2019, 16:09:19 Andrei Epure wrote:</h3>
<div class="paragraph">
<p>\[~nicolas.harraudeau]  - did you have a chance to look at the wording of this rule? I think it can be simplified&#8230;&#8203;</p>
</div>
</div>
</div>
</div>