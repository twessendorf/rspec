<div class="paragraph">
<p>Encryption operation mode and the padding scheme should be chosen appropriately to guarantee data confidentiality, integrity and authenticity:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>For block cipher encryption algorithms (like AES):</p>
<div class="ulist">
<ul>
<li>
<p>The GCM (Galois Counter Mode) mode which <a href="https://en.wikipedia.org/wiki/Galois/Counter_Mode#Mathematical_basis">works internally</a> with zero/no padding scheme, is recommended, as it is designed to provide both data authenticity (integrity) and confidentiality. Other similar modes are CCM, CWC, EAX, IAPM and OCB.</p>
</li>
<li>
<p>The CBC (Cipher Block Chaining) mode by itself provides only data confidentiality, it&#8217;s recommended to use it along with Message Authentication Code or similar to achieve data authenticity (integrity) too and thus to <a href="https://en.wikipedia.org/wiki/Padding_oracle_attack">prevent padding oracle attacks</a>.</p>
</li>
<li>
<p>The ECB (Electronic Codebook) mode doesn&#8217;t provide serious message confidentiality: under a given key any given plaintext block always gets encrypted to the same ciphertext block. This mode should not be used.</p>
</li>
</ul>
</div>
</li>
<li>
<p>For RSA encryption algorithm, the recommended padding scheme is OAEP.</p>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.aesmanaged?view=netframework-4.8">AesManaged</a> object with insecure mode:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AesManaged aes4 = new AesManaged
{
  KeySize = 128,
  BlockSize = 128,
  Mode = CipherMode.ECB, // Noncompliant
  Padding = PaddingMode.PKCS7
};</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rsacryptoserviceprovider?view=netframework-4.8">RSACryptoServiceProvider</a> object without OAEP padding:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RSACryptoServiceProvider RSA1 = new RSACryptoServiceProvider();
encryptedData = RSA1.Encrypt(dataToEncrypt, false); // Noncompliant: OAEP Padding is not used (second parameter set to false)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p>AES with GCM mode with <a href="https://www.bouncycastle.org/">bouncycastle</a> library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>GcmBlockCipher blockCipher = new GcmBlockCipher(new AesEngine()); // Compliant
blockCipher.Init(true, new AeadParameters(new KeyParameter(secretKey), 128, iv, null));</pre>
</div>
</div>
<div class="paragraph">
<p>AES with GCM mode with <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.aesgcm?view=netcore-3.0">AesGcm</a> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>var aesGcm = new AesGcm(key); // Compliant</pre>
</div>
</div>
<div class="paragraph">
<p>RSA with OAEP padding with <a href="https://docs.microsoft.com/en-us/dotnet/api/system.security.cryptography.rsacryptoserviceprovider?view=netframework-4.8">RSACryptoServiceProvider</a> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>RSACryptoServiceProvider RSA2 = new RSACryptoServiceProvider();
encryptedData = RSA2.Encrypt(dataToEncrypt, true); // Compliant: OAEP Padding is used (second parameter set to true)</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP Top 10 2021 Category A2</a> - Cryptographic Failures</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration">OWASP Top 10 2017 Category A6</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/327.html">MITRE, CWE-327</a> - Use of a Broken or Risky Cryptographic Algorithm</p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat3">SANS Top 25</a> - Porous Defenses</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Use a secure mode and padding scheme.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_on_22_oct_2019_202220_ann_campbell_wrote">on 22 Oct 2019, 20:22:20 Ann Campbell wrote:</h3>
<div class="paragraph">
<p>\[~eric.therond]Â a Compliant Solution should be code. If you have no code to show, then the additional details should be incorporated in the description.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_14_nov_2019_170739_christophe_zurn_wrote">on 14 Nov 2019, 17:07:39 Christophe Zurn wrote:</h3>
<div class="paragraph">
<p>\[~eric.therond] Note that C# has a GCM mode since .NET Core 3.0 (See https://github.com/dotnet/corefx/pull/31389), but not yet in .NET Framework. It would be nice to have this mentioned as an alternate Compliant Solution.</p>
</div>
<div class="paragraph">
<p>Also, the rule mentions "RSA encryption algorithm should be used with the recommended padding scheme (OAEP)", but there is no example for such Noncompliant/Compliant code example.</p>
</div>
</div>
<div class="sect2">
<h3 id="_on_15_nov_2019_093244_eric_therond_wrote">on 15 Nov 2019, 09:32:44 Eric Therond wrote:</h3>
<div class="paragraph">
<p>Thanks [~christophe.zurn] I have added additional examples and updated <a href="https://github.com/SonarSource/security-expected-issues/blob/master/dotnet/rules/vulnerabilities/RSPEC-5542/Startup.cs">security-expected-issues repository</a></p>
</div>
</div>
<div class="sect2">
<h3 id="_deprecates_s4585">deprecates: S4585</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s4729">deprecates: S4729</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s4432">deprecates: S4432</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s4787">deprecates: S4787</h3>

</div>
<div class="sect2">
<h3 id="_supercedes_s2277">supercedes: S2277</h3>

</div>
</div>
</div>