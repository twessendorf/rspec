<div class="paragraph">
<p>When using <code>sprintf</code> , it&#8217;s up to the developer to make sure the size of the buffer to be written to is large enough to avoid buffer overflows. Buffer overflows can cause the program to crash at a minimum. At worst, a carefully crafted overflow can cause malicious code to be executed.</p>
</div>
<div class="sect1">
<h2 id="_ask_yourself_whether">Ask Yourself Whether</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>if the provided buffer is large enough for the result of any possible call to the <code>sprintf</code> function (including all possible format strings and all possible additional arguments).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>There is a risk if you answered no to the above question.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_recommended_secure_coding_practices">Recommended Secure Coding Practices</h2>
<div class="sectionbody">
<div class="paragraph">
<p>There are fundamentally safer alternatives. <code>snprintf</code> is one of them. It takes the size of the buffer as an additional argument, preventing the function from overflowing the buffer.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Use <code>snprintf</code> instead of <code>sprintf</code>. The slight performance overhead can be afforded in a vast majority of projects.</p>
</li>
<li>
<p>Check the buffer size passed to <code>snprintf</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you are working in C&#43;&#43;, other safe alternative exist:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>std::string</code> should be the prefered type to store strings</p>
</li>
<li>
<p>You can format to a string using <code>std::ostringstream</code></p>
</li>
<li>
<p>Since C&#43;&#43;20, <code>std::format</code> is also available to format strings</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_sensitive_code_example">Sensitive Code Example</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>sprintf(str, "%s", message);   // Sensitive: `str` buffer size is not checked and it is vulnerable to overflows</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre>snprintf(str, sizeof(str), "%s", message); // Prevent overflows by enforcing a maximum size for `str` buffer</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_exceptions">Exceptions</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is a very common and acceptable pattern to compute the required size of the buffer with a call to <code>snprintf</code> with the same arguments into an empty buffer (this will fail, but return the necessary size), then to call <code>sprintf</code> as the bound check is not needed anymore. Note that 1 needs to be added by the size reported by <code>snprintf</code> to account for the terminal null character.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>size_t buflen = snprintf(0, 0, "%s", message);
char* buf = malloc(buflen) + 1; // For the final 0
sprintf(buf, "%s", message);{code}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A06_2021-Vulnerable_and_Outdated_Components/">OWASP Top 10 2021 Category A6</a> - Vulnerable and Outdated Components</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A9-Using_Components_with_Known_Vulnerabilities">OWASP Top 10 2017 Category A9</a> - Using Components with Known Vulnerabilities</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/676.html">MITRE, CWE-676</a> - Use of Potentially Dangerous Function</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/119.html">MITRE, CWE-119</a> - Improper Restriction of Operations within the Bounds of a Memory Buffer</p>
</li>
<li>
<p><a href="https://www.sans.org/top25-software-errors/#cat2">SANS Top 25</a> - Risky Resource Management</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Remove the use of this insecure 'sprintf' function.</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_relates_to_s1081">relates to: S1081</h3>

</div>
<div class="sect2">
<h3 id="_on_27_apr_2021_175451_bruno_wrote">on 27 Apr 2021, 17:54:51 Bruno wrote:</h3>
<div class="listingblock">
<div class="content">
<pre>char* buf = malloc(buflen) + 1; // For the final 0</pre>
</div>
</div>
<div class="paragraph">
<p>The +1 should be inside the malloc</p>
</div>
<div class="listingblock">
<div class="content">
<pre>char* buf = malloc(buflen + 1); // For the final 0</pre>
</div>
</div>
</div>
</div>
</div>