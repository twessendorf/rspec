<div class="paragraph">
<p>To establish a SSL/TLS connection not vulnerable to man-in-the-middle attacks, it&#8217;s essential to make sure the server presents the right certificate.</p>
</div>
<div class="paragraph">
<p>The certificate&#8217;s hostname-specific data should match the server hostname.</p>
</div>
<div class="paragraph">
<p>It&#8217;s not recommended to re-invent the wheel by implementing custom hostname verification.</p>
</div>
<div class="paragraph">
<p>TLS/SSL libraries provide built-in hostname verification functions that should be used.</p>
</div>
<div class="sect1">
<h2 id="_noncompliant_code_example">Noncompliant Code Example</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/curl/curl">libcurl</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;curl/curl.h&gt;

CURL *curl;
curl_global_init(CURL_GLOBAL_DEFAULT);

curl = curl_easy_init();
curl_easy_setopt(curl, CURLOPT_URL, "https://example.com/");
curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 1L);

curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 0L); // Noncompliant

//Perform the request
curl_easy_perform(curl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/openssl/openssl">OpenSSL</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;openssl/ssl.h&gt;

SSL_CTX *ctx = get_ctx();
SSL *ssl = SSL_new(ctx);

// ...

// By default hostname validation is disabled
// `SSL_set1_host` is not called
SSL_set_verify(ssl, SSL_VERIFY_PEER, NULL);

// ...

SSL_connect(ssl); // Noncompliant</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/randombit/botan">botan</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;botan/tls_client.h&gt;
#include &lt;botan/tls_callbacks.h&gt;
#include &lt;botan/tls_session_manager.h&gt;
#include &lt;botan/tls_policy.h&gt;
#include &lt;botan/auto_rng.h&gt;
#include &lt;botan/certstor.h&gt;
#include &lt;botan/certstor_system.h&gt;

class Callbacks : public Botan::TLS::Callbacks
{
// ...

virtual void tls_verify_cert_chain(
          const std::vector&lt;Botan::X509_Certificate&gt; &amp;cert_chain,
          const std::vector&lt;std::shared_ptr&lt;const Botan::OCSP::Response&gt;&gt; &amp;ocsp_responses,
          const std::vector&lt;Botan::Certificate_Store *&gt; &amp;trusted_roots,
          Botan::Usage_Type usage,
          const std::string &amp;hostname,
          const Botan::TLS::Policy &amp;policy) override {} // Noncompliant (secondary location), tls_verify_cert_chain never throws. Always accept server certificate and doesn't verify hostname
};

class Client_Credentials : public Botan::Credentials_Manager
{
// ...
};

Callbacks callbacks;
Botan::AutoSeeded_RNG rng;
Botan::TLS::Session_Manager_In_Memory session_mgr(rng);
Client_Credentials creds;
Botan::TLS::Strict_Policy policy;

// open the tls connection
Botan::TLS::Client client(callbacks, session_mgr, creds, policy, rng,
                          Botan::TLS::Server_Information("example.com", 443),
                          Botan::TLS::Protocol_Version::TLS_V12); // Noncompliant; uses an implementation of Botan::TLS::Callbacks that doesn't validate server hostname</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_compliant_solution">Compliant Solution</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/curl/curl">libcurl</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;curl/curl.h&gt;

CURL *curl;
curl_global_init(CURL_GLOBAL_DEFAULT);

curl = curl_easy_init();
curl_easy_setopt(curl, CURLOPT_URL, "https://example.com/");
curl_easy_setopt(curl, CURLOPT_SSL_VERIFYPEER, 1L);

curl_easy_setopt(curl, CURLOPT_SSL_VERIFYHOST, 2L); // Compliant

//Perform the request
curl_easy_perform(curl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/openssl/openssl">OpenSSL</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;openssl/ssl.h&gt;

SSL_CTX *ctx = get_ctx();
SSL *ssl = SSL_new(ctx);

// ...

SSL_set1_host(ssl, HOST_NAME); // Compliant
SSL_set_verify(ssl, SSL_VERIFY_PEER, NULL);

// ...

SSL_connect(ssl);</pre>
</div>
</div>
<div class="paragraph">
<p><a href="https://github.com/randombit/botan">botan</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre>#include &lt;botan/tls_client.h&gt;
#include &lt;botan/tls_callbacks.h&gt;
#include &lt;botan/tls_session_manager.h&gt;
#include &lt;botan/tls_policy.h&gt;
#include &lt;botan/auto_rng.h&gt;
#include &lt;botan/certstor.h&gt;
#include &lt;botan/certstor_system.h&gt;

// Compliant use the default implementation of tls_verify_cert_chain method which verify server certificate and hostname
class Callbacks : public Botan::TLS::Callbacks
{
// ...
};

class Client_Credentials : public Botan::Credentials_Manager
{
// ...
};

Callbacks callbacks;
Botan::AutoSeeded_RNG rng;
Botan::TLS::Session_Manager_In_Memory session_mgr(rng);
Client_Credentials creds;
Botan::TLS::Strict_Policy policy;

// open the tls connection
Botan::TLS::Client client(callbacks, session_mgr, creds, policy, rng,
                          Botan::TLS::Server_Information("example.com", 443),
                          Botan::TLS::Protocol_Version::TLS_V12); // Compliant; uses an implementation of Botan::TLS::Callbacks that validate server hostname</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_see">See</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">OWASP Top 10 2021 Category A2</a> - Cryptographic Failures</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">OWASP Top 10 2021 Category A5</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">OWASP Top 10 2021 Category A7</a> - Identification and Authentication Failures</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A3-Sensitive_Data_Exposure">OWASP Top 10 2017 Category A3</a> - Sensitive Data Exposure</p>
</li>
<li>
<p><a href="https://www.owasp.org/index.php/Top_10-2017_A6-Security_Misconfiguration">OWASP Top 10 2017 Category A6</a> - Security Misconfiguration</p>
</li>
<li>
<p><a href="https://mobile-security.gitbook.io/masvs/security-requirements/0x10-v5-network_communication_requirements">Mobile AppSec Verification Standard</a> - Network Communication Requirements</p>
</li>
<li>
<p><a href="https://owasp.org/www-project-mobile-top-10/2016-risks/m3-insecure-communication">OWASP Mobile Top 10 2016 Category M3</a> - Insecure Communication</p>
</li>
<li>
<p><a href="https://cwe.mitre.org/data/definitions/297.html">MITRE, CWE-297</a> - Improper Validation of Certificate with Host Mismatch</p>
</li>
</ul>
</div>
<hr/>
</div>
</div>
<div class="sect1">
<h2 id="_implementation_specification">Implementation Specification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_message">Message</h3>
<div class="paragraph">
<p>Enable server hostname verification on this SSL/TLS connection</p>
</div>
<hr/>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_comments_and_links">Comments And Links</h2>
<div class="sectionbody">
<div class="paragraph">
<p>(visible only on this page)</p>
</div>
<div class="sect2">
<h3 id="_deprecates_s3510">deprecates: S3510</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s4499">deprecates: S4499</h3>

</div>
<div class="sect2">
<h3 id="_deprecates_s5326">deprecates: S5326</h3>

</div>
<div class="sect2">
<h3 id="_is_related_to_s4830">is related to: S4830</h3>

</div>
<div class="sect2">
<h3 id="_on_5_nov_2020_113949_pierre_loup_tristant_wrote">on 5 Nov 2020, 11:39:49 Pierre-Loup Tristant wrote:</h3>
<div class="paragraph">
<p>.NET API offers <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.security.remotecertificatevalidationcallback">a single callback</a> to override TLS certificates chain and hostname validation. RSPEC-4830 already detects that this callback always accept the server certificate without validation. There is no easy way to detects code that validates the certificate chain and fails to validate the server hostname in this callback.</p>
</div>
<div class="paragraph">
<p>Therefore, this will not be implemented for .NET langauges.</p>
</div>
</div>
</div>
</div>